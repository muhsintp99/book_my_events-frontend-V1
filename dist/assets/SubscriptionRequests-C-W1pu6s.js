import{h as j,j as e,u as de,r as s,B as n,K as he,T as o,d as x,G as U,k as w,q as pe,a4 as xe,a2 as S,g as N,F as ue,I as me,H as je,M as G,N as ge,Q as fe,U as C,V as l,W as ye,C as J,S as m,o as M,n as D,y as be,c as Q,_ as z,$ as q,a0 as V,D as K,a1 as E}from"./index-CXSvRfrP.js";import{C as ve}from"./CheckCircle-D1WeS_Uo.js";import{V as we}from"./Visibility-CcOJmSZn.js";import{S as Se}from"./Search-CWf_i7h6.js";import{E as Ce}from"./FileDownload-aSMRkFzo.js";import{u as L,w as We}from"./xlsx-eY9-kAPw.js";const Pe=j(e.jsx("path",{d:"M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m0 18H4V8h16z"})),F=j(e.jsx("path",{d:"M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2m5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12z"})),Ie=j(e.jsx("path",{d:"M13.66 7c-.56-1.18-1.76-2-3.16-2H6V3h12v2h-3.26c.48.58.84 1.26 1.05 2H18v2h-2.02c-.25 2.8-2.61 5-5.48 5h-.73l6.73 7h-2.77L7 14v-2h3.5c1.76 0 3.22-1.3 3.46-3H6V7z"})),X=j(e.jsx("path",{d:"M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2m0 14H4v-6h16zm0-10H4V6h16z"})),Y=j(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2M7 13.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5m5 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5m5 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5"})),Re=j(e.jsx("path",{d:"m16 6 2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"})),qe=()=>{const d=de(),[h,Z]=s.useState([]),[g,ee]=s.useState(""),[W,ke]=s.useState("all"),[f,te]=s.useState("all"),[c,P]=s.useState({open:!1,data:null}),[I,y]=s.useState({open:!1,data:null,action:""}),[p,R]=s.useState({open:!1,data:null}),[b,v]=s.useState(""),[ae,oe]=s.useState([]),[re,$]=s.useState(!1),[B,H]=s.useState(!1),[u,se]=s.useState(0),k=()=>localStorage.getItem("token")||sessionStorage.getItem("token")||"";s.useEffect(()=>{T(),ie();const a=new URLSearchParams(window.location.search).get("orderId");a&&O(a)},[]);const O=async t=>{try{const i=await(await fetch("https://api.bookmyevent.ae/api/admin/subscription-request/payment/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderId:t})})).json();i.success?(alert("✅ Payment Successful! Subscription has been activated."),window.history.replaceState({},document.title,window.location.pathname),T()):i.status==="pending"?setTimeout(()=>O(t),3e3):(alert("❌ Payment Verification Failed: "+(i.message||"Unknown error")),window.history.replaceState({},document.title,window.location.pathname))}catch(a){console.error("Verification error:",a)}},ne=async t=>{H(!0);try{const a=k(),r=await(await fetch("https://api.bookmyevent.ae/api/admin/subscription-request/payment/initiate",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify({requestId:t.id,adminNote:b||`Payment for ${t.planName}`})})).json();r.success&&r.payment_links?.web?window.location.href=r.payment_links.web:alert(r.message||"Failed to initiate payment")}catch(a){console.error("Payment initiation error:",a),alert("Error connecting to payment gateway")}finally{H(!1)}},T=async()=>{$(!0);try{const a=await(await fetch("https://api.bookmyevent.ae/api/admin/subscription/requests",{headers:{Authorization:`Bearer ${k()}`}})).json();if(a.success){const i=a.requests.map(r=>({id:r._id,userName:r.userId?`${r.userId.firstName||""} ${r.userId.lastName||""}`.trim():"Unknown",userEmail:r.userId?.email||"",userPhone:r.userId?.phone||"",userAvatar:r.userId?.avatar||"",planName:r.planId?.name||"N/A",planPrice:r.planId?.price||0,planDuration:r.planId?.durationInDays||0,module:r.moduleId?.title||"Other",status:r.status,requestDate:new Date(r.createdAt).toLocaleDateString(),adminNote:r.adminNote||""}));Z(i)}}catch(t){console.error("Fetch error:",t)}finally{$(!1)}},ie=async()=>{try{const a=await(await fetch("https://api.bookmyevent.ae/api/modules")).json();oe(Array.isArray(a)?a:a.modules||[])}catch(t){console.error("Modules error:",t)}},le=t=>{const a={pending:{label:"Pending",color:"warning",icon:e.jsx(Y,{fontSize:"small"})},approved:{label:"Approved",color:"success",icon:e.jsx(ve,{fontSize:"small"})},rejected:{label:"Rejected",color:"error",icon:e.jsx(F,{fontSize:"small"})}},i=a[t]||a.pending;return e.jsx(M,{label:i.label,color:i.color,size:"small",icon:i.icon,sx:{fontWeight:600,px:1}})},_=s.useMemo(()=>h.filter(t=>{const a=t.userName.toLowerCase().includes(g.toLowerCase())||t.userEmail.toLowerCase().includes(g.toLowerCase()),i=W==="all"||t.status===W,r=f==="all"||t.module===f,ce=u===0||u===1&&t.status==="pending"||u===2&&t.status==="approved"||u===3&&t.status==="rejected";return a&&i&&r&&ce}),[h,g,W,f,u]),A=s.useMemo(()=>({total:h.length,pending:h.filter(t=>t.status==="pending").length,revenue:h.filter(t=>t.status==="approved").reduce((t,a)=>t+a.planPrice,0)}),[h]);return e.jsxs(n,{sx:{p:{xs:2,md:4},background:"#f4f7fe",minHeight:"100vh"},children:[e.jsxs(he,{elevation:0,sx:{p:4,mb:4,borderRadius:4,background:`linear-gradient(45deg, ${d.palette.primary.main}, ${d.palette.primary.dark})`,color:"white"},children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",flexWrap:"wrap",gap:2},children:[e.jsxs(n,{children:[e.jsx(o,{variant:"h4",fontWeight:800,letterSpacing:-.5,color:"white",children:"Subscription Requests"}),e.jsx(o,{variant:"body1",sx:{opacity:.95,color:"white",mt:.5},children:"Manage and approve vendor plan applications"})]}),e.jsx(x,{variant:"contained",startIcon:e.jsx(Ce,{}),onClick:()=>{const t=L.json_to_sheet(h),a=L.book_new();L.book_append_sheet(a,t,"Requests"),We(a,"Subscriptions.xlsx")},sx:{bgcolor:"white",color:d.palette.primary.main,fontWeight:700,"&:hover":{bgcolor:"#f0f0f0"}},children:"Export Report"})]}),e.jsx(U,{container:!0,spacing:3,sx:{mt:3},children:[{label:"Total Applications",value:A.total,icon:e.jsx(Re,{}),color:"#2196f3"},{label:"Pending Review",value:A.pending,icon:e.jsx(Y,{}),color:"#ff9800"},{label:"Total Revenue",value:`₹${A.revenue.toLocaleString()}`,icon:e.jsx(Ie,{}),color:"#4caf50"}].map((t,a)=>e.jsx(U,{item:!0,xs:12,sm:4,children:e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:2,p:2,borderRadius:3,bgcolor:"rgba(255,255,255,0.2)",backdropFilter:"blur(10px)"},children:[e.jsx(w,{sx:{bgcolor:"white",color:t.color,width:56,height:56},children:t.icon}),e.jsxs(n,{children:[e.jsx(o,{variant:"caption",sx:{opacity:.95,color:"white",fontWeight:600},children:t.label}),e.jsx(o,{variant:"h5",fontWeight:700,color:"white",children:t.value})]})]})},a))})]}),e.jsxs(pe,{elevation:0,sx:{borderRadius:4,border:"1px solid",borderColor:"divider"},children:[e.jsx(n,{sx:{borderBottom:1,borderColor:"divider",px:2},children:e.jsxs(xe,{value:u,onChange:(t,a)=>se(a),sx:{"& .MuiTab-root":{fontWeight:600,py:2,color:"text.secondary","&.Mui-selected":{color:"primary.main"}}},children:[e.jsx(S,{label:"All Requests"}),e.jsx(S,{label:"Pending"}),e.jsx(S,{label:"Approved"}),e.jsx(S,{label:"Rejected"})]})}),e.jsxs(n,{sx:{p:3,display:"flex",gap:2,flexWrap:"wrap",alignItems:"center",bgcolor:"#fafafa"},children:[e.jsx(N,{size:"small",placeholder:"Search vendor name or email...",value:g,onChange:t=>ee(t.target.value),InputProps:{startAdornment:e.jsx(Se,{sx:{mr:1,color:"text.secondary"}})},sx:{flexGrow:1,maxWidth:400,bgcolor:"white","& .MuiInputBase-input":{color:"text.primary"}}}),e.jsxs(ue,{size:"small",sx:{minWidth:160,bgcolor:"white"},children:[e.jsx(me,{sx:{color:"text.secondary"},children:"Module"}),e.jsxs(je,{value:f,label:"Module",onChange:t=>te(t.target.value),sx:{color:"text.primary"},children:[e.jsx(G,{value:"all",children:"All Modules"}),ae.map(t=>e.jsx(G,{value:t.title,children:t.title},t._id))]})]})]}),e.jsxs(ge,{children:[e.jsx(fe,{sx:{bgcolor:"#f8f9fc"},children:e.jsxs(C,{children:[e.jsx(l,{sx:{fontWeight:700,color:"text.primary"},children:"Vendor Details"}),e.jsx(l,{sx:{fontWeight:700,color:"text.primary"},children:"Plan Info"}),e.jsx(l,{sx:{fontWeight:700,color:"text.primary"},children:"Request Date"}),e.jsx(l,{sx:{fontWeight:700,color:"text.primary"},children:"Status"}),e.jsx(l,{align:"right",sx:{fontWeight:700,color:"text.primary"},children:"Management"})]})}),e.jsx(ye,{children:re?e.jsx(C,{children:e.jsx(l,{colSpan:5,align:"center",sx:{py:10},children:e.jsx(J,{})})}):_.length===0?e.jsx(C,{children:e.jsxs(l,{colSpan:5,align:"center",sx:{py:10},children:[e.jsx(o,{color:"text.secondary",variant:"h6",children:"No requests found"}),e.jsx(o,{color:"text.secondary",variant:"body2",children:"Try adjusting your filters"})]})}):_.map(t=>e.jsxs(C,{hover:!0,children:[e.jsx(l,{children:e.jsxs(m,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(w,{src:t.userAvatar,sx:{width:45,height:45,bgcolor:"primary.light",color:"primary.main",fontWeight:700},children:t.userName[0]}),e.jsxs(n,{children:[e.jsx(o,{variant:"body2",fontWeight:700,color:"text.primary",children:t.userName}),e.jsx(o,{variant:"caption",color:"text.secondary",children:t.userEmail})]})]})}),e.jsxs(l,{children:[e.jsx(o,{variant:"body2",fontWeight:600,color:"text.primary",children:t.planName}),e.jsxs(m,{direction:"row",spacing:1,sx:{mt:.5},children:[e.jsx(M,{size:"small",label:`₹${t.planPrice}`,sx:{height:20,bgcolor:D(d.palette.primary.main,.1),color:"primary.main",fontWeight:700,"& .MuiChip-label":{color:"primary.main"}}}),e.jsx(M,{size:"small",label:`${t.planDuration} Days`,variant:"outlined",sx:{height:20,"& .MuiChip-label":{color:"text.primary"}}})]})]}),e.jsx(l,{children:e.jsxs(m,{direction:"row",spacing:1,alignItems:"center",color:"text.secondary",children:[e.jsx(Pe,{sx:{fontSize:14,color:"text.secondary"}}),e.jsx(o,{variant:"caption",color:"text.secondary",children:t.requestDate})]})}),e.jsx(l,{children:le(t.status)}),e.jsx(l,{align:"right",children:e.jsxs(m,{direction:"row",spacing:1,justifyContent:"flex-end",children:[e.jsx(be,{title:"View Info",children:e.jsx(Q,{onClick:()=>P({open:!0,data:t}),size:"small",sx:{color:"text.primary"},children:e.jsx(we,{fontSize:"small"})})}),t.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"small",variant:"contained",disableElevation:!0,onClick:()=>R({open:!0,data:t}),startIcon:e.jsx(X,{}),sx:{borderRadius:2,textTransform:"none",fontWeight:700,color:"white"},children:"Pay & Approve"}),e.jsx(Q,{color:"error",onClick:()=>y({open:!0,data:t,action:"reject"}),size:"small",children:e.jsx(F,{fontSize:"small"})})]})]})})]},t.id))})]})]}),e.jsxs(z,{open:p.open,onClose:()=>R({open:!1,data:null}),fullWidth:!0,maxWidth:"xs",PaperProps:{sx:{borderRadius:4}},children:[e.jsxs(q,{sx:{textAlign:"center",pt:4},children:[e.jsx(w,{sx:{m:"0 auto",bgcolor:D(d.palette.primary.main,.1),color:"primary.main",width:60,height:60,mb:2},children:e.jsx(X,{fontSize:"large"})}),e.jsx(o,{variant:"h5",fontWeight:800,color:"text.primary",children:"Confirm Payment"})]}),e.jsxs(V,{children:[e.jsxs(n,{sx:{bgcolor:"#f8f9fc",p:2,borderRadius:3,mb:3},children:[e.jsx(o,{variant:"caption",color:"text.secondary",fontWeight:600,children:"Total Payable Amount"}),e.jsxs(o,{variant:"h4",fontWeight:800,color:"primary.main",children:["₹",p.data?.planPrice]}),e.jsx(K,{sx:{my:1.5}}),e.jsxs(o,{variant:"body2",fontWeight:600,color:"text.primary",children:[p.data?.planName," Plan"]}),e.jsxs(o,{variant:"caption",display:"block",color:"text.secondary",children:[p.data?.userName," (",p.data?.module,")"]})]}),e.jsx(N,{fullWidth:!0,multiline:!0,rows:3,label:"Note for Vendor",placeholder:"Add a comment about the approval...",value:b,onChange:t=>v(t.target.value),sx:{mt:1,"& .MuiInputBase-input":{color:"text.primary"}}})]}),e.jsxs(E,{sx:{p:3,pt:0},children:[e.jsx(x,{fullWidth:!0,onClick:()=>R({open:!1}),sx:{fontWeight:700,color:"text.primary"},children:"Cancel"}),e.jsx(x,{fullWidth:!0,variant:"contained",disableElevation:!0,onClick:()=>ne(p.data),disabled:B,sx:{py:1.5,borderRadius:3,fontWeight:700,color:"white"},children:B?e.jsx(J,{size:24,color:"inherit"}):`Pay ₹${p.data?.planPrice}`})]})]}),e.jsxs(z,{open:c.open,onClose:()=>P({open:!1}),fullWidth:!0,maxWidth:"sm",PaperProps:{sx:{borderRadius:4}},children:[e.jsx(q,{sx:{fontWeight:800,color:"text.primary"},children:"Application Overview"}),e.jsx(V,{children:c.data&&e.jsxs(m,{spacing:3,sx:{mt:1},children:[e.jsxs(n,{sx:{p:2,borderRadius:3,border:"1px solid #eee",bgcolor:"#fafafa"},children:[e.jsx(o,{variant:"caption",color:"primary.main",fontWeight:700,gutterBottom:!0,children:"VENDOR PROFILE"}),e.jsx(o,{variant:"h6",fontWeight:700,color:"text.primary",children:c.data.userName}),e.jsx(o,{variant:"body2",color:"text.secondary",children:c.data.userEmail}),e.jsx(o,{variant:"body2",color:"text.secondary",children:c.data.userPhone||"No Phone Contact"})]}),e.jsxs(n,{sx:{p:2,borderRadius:3,bgcolor:d.palette.primary.main,color:"white"},children:[e.jsx(o,{variant:"caption",sx:{color:"white",opacity:.9},fontWeight:700,children:"SELECTED PLAN"}),e.jsx(o,{variant:"h6",fontWeight:700,color:"white",children:c.data.planName}),e.jsxs(m,{direction:"row",spacing:2,sx:{mt:1},children:[e.jsxs(o,{variant:"h5",fontWeight:800,color:"white",children:["₹",c.data.planPrice]}),e.jsx(K,{orientation:"vertical",flexItem:!0,sx:{bgcolor:"white",opacity:.3}}),e.jsxs(n,{children:[e.jsxs(o,{variant:"body2",fontWeight:700,color:"white",children:[c.data.planDuration," Days"]}),e.jsx(o,{variant:"caption",sx:{color:"white",opacity:.8},children:"Validity"})]})]})]}),c.data.adminNote&&e.jsxs(n,{sx:{p:2,borderRadius:3,bgcolor:"#fff8e1",border:"1px solid #ffe082"},children:[e.jsx(o,{variant:"caption",color:"#f57c00",fontWeight:700,children:"ADMIN COMMENTS"}),e.jsx(o,{variant:"body2",color:"text.primary",children:c.data.adminNote})]})]})}),e.jsx(E,{sx:{p:3},children:e.jsx(x,{onClick:()=>P({open:!1}),fullWidth:!0,variant:"outlined",sx:{borderRadius:3,fontWeight:700,color:"text.primary",borderColor:"divider"},children:"Close View"})})]}),e.jsxs(z,{open:I.open&&I.action==="reject",onClose:()=>y({open:!1,data:null,action:""}),fullWidth:!0,maxWidth:"xs",PaperProps:{sx:{borderRadius:4}},children:[e.jsxs(q,{sx:{textAlign:"center",pt:4},children:[e.jsx(w,{sx:{m:"0 auto",bgcolor:D(d.palette.error.main,.1),color:"error.main",width:60,height:60,mb:2},children:e.jsx(F,{fontSize:"large"})}),e.jsx(o,{variant:"h5",fontWeight:800,color:"text.primary",children:"Reject Request"})]}),e.jsxs(V,{children:[e.jsx(o,{variant:"body2",color:"text.secondary",sx:{mb:2,textAlign:"center"},children:"Are you sure you want to reject this subscription request?"}),e.jsx(N,{fullWidth:!0,multiline:!0,rows:3,label:"Reason for Rejection",placeholder:"Provide a reason for rejecting this request...",value:b,onChange:t=>v(t.target.value),sx:{"& .MuiInputBase-input":{color:"text.primary"}}})]}),e.jsxs(E,{sx:{p:3,pt:0},children:[e.jsx(x,{fullWidth:!0,onClick:()=>{y({open:!1,data:null,action:""}),v("")},sx:{fontWeight:700,color:"text.primary"},children:"Cancel"}),e.jsx(x,{fullWidth:!0,variant:"contained",color:"error",disableElevation:!0,onClick:async()=>{try{const t=k();await fetch(`https://api.bookmyevent.ae/api/admin/subscription/requests/${I.data.id}/reject`,{method:"PUT",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({adminNote:b})}),T(),y({open:!1,data:null,action:""}),v("")}catch{alert("Reject failed")}},sx:{py:1.5,borderRadius:3,fontWeight:700,color:"white"},children:"Reject Request"})]})]})]})};export{qe as default};
