import{r as c,j as e,B as l,T as o,o as R,aa as S,F as B,I as W,H as N,M as b,g as _,b as P,d as V,l as z,m as F,N as H,Q,U as m,V as t,W as q,q as O}from"./index-D781LPqD.js";import{S as Z}from"./Search-QpPOBNxK.js";import{M as $}from"./MoreVert-DR0y-kB9.js";const G=S(O)({borderRadius:8,boxShadow:"0 1px 3px rgba(0, 0, 0, 0.1)",border:"1px solid #e0e0e0"}),u=S(l)({padding:24,borderRadius:8,flex:1,textAlign:"center",border:"1px solid #e0e0e0"}),J=S(l)({width:40,height:40,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",marginRight:12,fontSize:"20px"}),ee=()=>{const[d,y]=c.useState([]),[C,p]=c.useState([]),[h,v]=c.useState(""),[f,k]=c.useState("All"),[w,g]=c.useState(null),I=!!w;c.useEffect(()=>{j(),E();const n=a=>{a.key==="subscriptionUpdated"&&a.newValue==="true"&&(console.log("ðŸ”„ Subscription updated - refreshing list"),j(),localStorage.removeItem("subscriptionUpdated"))};window.addEventListener("storage",n);const s=()=>{console.log("ðŸ”„ Subscription updated (same tab) - refreshing list"),j()};return window.addEventListener("subscriptionUpdated",s),()=>{window.removeEventListener("storage",n),window.removeEventListener("subscriptionUpdated",s)}},[]);const j=async()=>{try{const s=await(await fetch("https://api.bookmyevent.ae/api/subscription/all")).json();if(s.success){const a=s.subscriptions.map(r=>{const i=new Date(r.endDate);return{id:r._id,name:r.userId?.storeName||r.userId?.businessName||r.userId?.name||"Unknown Store",module:r.moduleId?.title||"Unknown",moduleId:r.moduleId?._id||"none",package:r.planId?.name||"N/A",price:`â‚¹${r.planId?.price||0}`,expDate:i,expDateString:i.toDateString(),used:1,icon:"ðŸª",iconBg:"#6c5ce7"}});y(a)}}catch(n){console.log("Error fetching subscriptions:",n)}},E=async()=>{try{const s=await(await fetch("https://api.bookmyevent.ae/api/modules")).json();Array.isArray(s)?p(s):Array.isArray(s.modules)?p(s.modules):Array.isArray(s.data)&&p(s.data)}catch(n){console.log("Error fetching modules:",n)}},x=d.filter(n=>{const s=n.name.toLowerCase().includes(h.toLowerCase())||n.package.toLowerCase().includes(h.toLowerCase())||n.module.toLowerCase().includes(h.toLowerCase()),a=f==="All"||n.moduleId===f;return s&&a}),A=d.length,D=d.filter(n=>n.expDate>new Date).length,L=d.filter(n=>n.expDate<new Date).length,M=d.filter(n=>{const s=new Date,a=(n.expDate-s)/(1e3*60*60*24);return a>0&&a<=7}).length,U=()=>{const n=[];n.push(["Sl","Store Name","Module","Package","Price","Exp Date","Used"].join(",")),x.forEach((i,T)=>{n.push([T+1,i.name,i.module,i.package,i.price,i.expDateString,i.used].join(","))});const s=new Blob([n.join(`
`)],{type:"text/csv"}),a=URL.createObjectURL(s),r=document.createElement("a");r.href=a,r.download="subscribed_store_list.csv",r.click()};return e.jsxs(l,{sx:{padding:3,backgroundColor:"#fafafa",minHeight:"100vh"},children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",mb:3},children:[e.jsx(o,{variant:"h5",fontWeight:600,children:"Subscribed Store List"}),e.jsx(R,{label:"All Zones",variant:"outlined"})]}),e.jsxs(l,{sx:{display:"flex",gap:2,mb:4},children:[e.jsxs(u,{sx:{background:"linear-gradient(180deg, #e8f4ff 0%, #e6f3ff 100%)",borderColor:"#d0eaff"},children:[e.jsx(o,{variant:"h4",fontWeight:700,color:"#0b66b2",children:A}),e.jsx(o,{color:"#0b66b2",children:"Total Subscribed User"})]}),e.jsxs(u,{sx:{background:"linear-gradient(180deg, #eaf6ea 0%, #e8f5e9 100%)",borderColor:"#dff0df"},children:[e.jsx(o,{variant:"h4",fontWeight:700,color:"#2e7d32",children:D}),e.jsx(o,{color:"#2e7d32",children:"Active Subscriptions"})]}),e.jsxs(u,{sx:{background:"linear-gradient(180deg, #fff6ea 0%, #fff3e0 100%)",borderColor:"#ffe9cc"},children:[e.jsx(o,{variant:"h4",fontWeight:700,color:"#b45f08",children:L}),e.jsx(o,{color:"#b45f08",children:"Expired Subscription"})]}),e.jsxs(u,{sx:{background:"linear-gradient(180deg, #fffdf2 0%, #fff8e1 100%)",borderColor:"#fff2c9"},children:[e.jsx(o,{variant:"h4",fontWeight:700,color:"#a66a00",children:M}),e.jsx(o,{color:"#a66a00",children:"Expiring Soon"})]})]}),e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",mb:2},children:[e.jsxs(o,{variant:"h6",children:["Store List ",x.length]}),e.jsxs(l,{sx:{display:"flex",gap:2},children:[e.jsxs(B,{size:"small",sx:{minWidth:150},children:[e.jsx(W,{children:"Module"}),e.jsxs(N,{value:f,label:"Module",onChange:n=>k(n.target.value),children:[e.jsx(b,{value:"All",children:"All"}),C.map(n=>e.jsx(b,{value:n._id,children:n.title},n._id))]})]}),e.jsx(_,{size:"small",placeholder:"Search store / plan / module",value:h,onChange:n=>v(n.target.value),InputProps:{startAdornment:e.jsx(P,{position:"start",children:e.jsx(Z,{})})},sx:{minWidth:260}}),e.jsx(V,{variant:"outlined",startIcon:e.jsx($,{}),onClick:n=>g(n.currentTarget),children:"Export"}),e.jsx(z,{open:I,anchorEl:w,onClose:()=>g(null),children:e.jsx(b,{onClick:()=>{U(),g(null)},children:"CSV"})})]})]}),e.jsx(G,{children:e.jsx(F,{sx:{p:0},children:e.jsxs(H,{children:[e.jsx(Q,{children:e.jsxs(m,{sx:{backgroundColor:"#f8f9fa"},children:[e.jsx(t,{children:"Sl"}),e.jsx(t,{children:"Store Info"}),e.jsx(t,{children:"Module"}),e.jsx(t,{children:"Package"}),e.jsx(t,{children:"Price"}),e.jsx(t,{children:"Exp Date"}),e.jsx(t,{align:"center",children:"Used"})]})}),e.jsxs(q,{children:[x.map((n,s)=>e.jsxs(m,{hover:!0,children:[e.jsx(t,{children:s+1}),e.jsx(t,{children:e.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(J,{sx:{backgroundColor:n.iconBg},children:n.icon}),e.jsx(o,{children:n.name})]})}),e.jsx(t,{children:n.module}),e.jsx(t,{children:n.package}),e.jsx(t,{children:n.price}),e.jsx(t,{children:n.expDateString}),e.jsx(t,{align:"center",children:n.used})]},n.id)),x.length===0&&e.jsx(m,{children:e.jsx(t,{colSpan:7,align:"center",sx:{py:3},children:"No stores found"})})]})]})})})]})};export{ee as default};
