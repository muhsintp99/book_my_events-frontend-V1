import{h as Y,j as e,u as de,r as s,B as i,K as he,T as o,d as x,G as H,k as v,q as pe,a4 as xe,a2 as w,g as A,F as ue,I as me,H as je,M as U,N as ge,Q as fe,U as S,V as l,W as ye,C as G,S as m,o as N,n as D,y as be,c as J,_ as M,$ as z,a0 as q,D as Q,a1 as E}from"./index-C-AtCVLN.js";import{C as ve}from"./CheckCircle-Cgo6WuzL.js";import{T as we,P as K,C as Se,a as V}from"./TrendingUp-Cim9kqxe.js";import{V as Ce}from"./Visibility-DKovfMtT.js";import{S as We}from"./Search-B53zclG-.js";import{E as Pe}from"./FileDownload-Cc87oadK.js";import{u as L,w as Ie}from"./xlsx-eY9-kAPw.js";const Re=Y(e.jsx("path",{d:"M13.66 7c-.56-1.18-1.76-2-3.16-2H6V3h12v2h-3.26c.48.58.84 1.26 1.05 2H18v2h-2.02c-.25 2.8-2.61 5-5.48 5h-.73l6.73 7h-2.77L7 14v-2h3.5c1.76 0 3.22-1.3 3.46-3H6V7z"})),X=Y(e.jsx("path",{d:"M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2m0 14H4v-6h16zm0-10H4V6h16z"})),Ee=()=>{const d=de(),[h,Z]=s.useState([]),[j,ee]=s.useState(""),[C,Te]=s.useState("all"),[g,te]=s.useState("all"),[c,W]=s.useState({open:!1,data:null}),[P,f]=s.useState({open:!1,data:null,action:""}),[p,I]=s.useState({open:!1,data:null}),[y,b]=s.useState(""),[ae,oe]=s.useState([]),[re,F]=s.useState(!1),[$,B]=s.useState(!1),[u,se]=s.useState(0),R=()=>localStorage.getItem("token")||sessionStorage.getItem("token")||"";s.useEffect(()=>{T(),ne();const a=new URLSearchParams(window.location.search).get("orderId");a&&O(a)},[]);const O=async t=>{try{const n=await(await fetch("https://api.bookmyevent.ae/api/admin/subscription-request/payment/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderId:t})})).json();n.success?(alert("✅ Payment Successful! Subscription has been activated."),window.history.replaceState({},document.title,window.location.pathname),T()):n.status==="pending"?setTimeout(()=>O(t),3e3):(alert("❌ Payment Verification Failed: "+(n.message||"Unknown error")),window.history.replaceState({},document.title,window.location.pathname))}catch(a){console.error("Verification error:",a)}},ie=async t=>{B(!0);try{const a=R(),r=await(await fetch("https://api.bookmyevent.ae/api/admin/subscription-request/payment/initiate",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify({requestId:t.id,adminNote:y||`Payment for ${t.planName}`})})).json();r.success&&r.payment_links?.web?window.location.href=r.payment_links.web:alert(r.message||"Failed to initiate payment")}catch(a){console.error("Payment initiation error:",a),alert("Error connecting to payment gateway")}finally{B(!1)}},T=async()=>{F(!0);try{const a=await(await fetch("https://api.bookmyevent.ae/api/admin/subscription/requests",{headers:{Authorization:`Bearer ${R()}`}})).json();if(a.success){const n=a.requests.map(r=>({id:r._id,userName:r.userId?`${r.userId.firstName||""} ${r.userId.lastName||""}`.trim():"Unknown",userEmail:r.userId?.email||"",userPhone:r.userId?.phone||"",userAvatar:r.userId?.avatar||"",planName:r.planId?.name||"N/A",planPrice:r.planId?.price||0,planDuration:r.planId?.durationInDays||0,module:r.moduleId?.title||"Other",status:r.status,requestDate:new Date(r.createdAt).toLocaleDateString(),adminNote:r.adminNote||""}));Z(n)}}catch(t){console.error("Fetch error:",t)}finally{F(!1)}},ne=async()=>{try{const a=await(await fetch("https://api.bookmyevent.ae/api/modules")).json();oe(Array.isArray(a)?a:a.modules||[])}catch(t){console.error("Modules error:",t)}},le=t=>{const a={pending:{label:"Pending",color:"warning",icon:e.jsx(K,{fontSize:"small"})},approved:{label:"Approved",color:"success",icon:e.jsx(ve,{fontSize:"small"})},rejected:{label:"Rejected",color:"error",icon:e.jsx(V,{fontSize:"small"})}},n=a[t]||a.pending;return e.jsx(N,{label:n.label,color:n.color,size:"small",icon:n.icon,sx:{fontWeight:600,px:1}})},_=s.useMemo(()=>h.filter(t=>{const a=t.userName.toLowerCase().includes(j.toLowerCase())||t.userEmail.toLowerCase().includes(j.toLowerCase()),n=C==="all"||t.status===C,r=g==="all"||t.module===g,ce=u===0||u===1&&t.status==="pending"||u===2&&t.status==="approved"||u===3&&t.status==="rejected";return a&&n&&r&&ce}),[h,j,C,g,u]),k=s.useMemo(()=>({total:h.length,pending:h.filter(t=>t.status==="pending").length,revenue:h.filter(t=>t.status==="approved").reduce((t,a)=>t+a.planPrice,0)}),[h]);return e.jsxs(i,{sx:{p:{xs:2,md:4},background:"#f4f7fe",minHeight:"100vh"},children:[e.jsxs(he,{elevation:0,sx:{p:4,mb:4,borderRadius:4,background:`linear-gradient(45deg, ${d.palette.primary.main}, ${d.palette.primary.dark})`,color:"white"},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",flexWrap:"wrap",gap:2},children:[e.jsxs(i,{children:[e.jsx(o,{variant:"h4",fontWeight:800,letterSpacing:-.5,color:"white",children:"Subscription Requests"}),e.jsx(o,{variant:"body1",sx:{opacity:.95,color:"white",mt:.5},children:"Manage and approve vendor plan applications"})]}),e.jsx(x,{variant:"contained",startIcon:e.jsx(Pe,{}),onClick:()=>{const t=L.json_to_sheet(h),a=L.book_new();L.book_append_sheet(a,t,"Requests"),Ie(a,"Subscriptions.xlsx")},sx:{bgcolor:"white",color:d.palette.primary.main,fontWeight:700,"&:hover":{bgcolor:"#f0f0f0"}},children:"Export Report"})]}),e.jsx(H,{container:!0,spacing:3,sx:{mt:3},children:[{label:"Total Applications",value:k.total,icon:e.jsx(we,{}),color:"#2196f3"},{label:"Pending Review",value:k.pending,icon:e.jsx(K,{}),color:"#ff9800"},{label:"Total Revenue",value:`₹${k.revenue.toLocaleString()}`,icon:e.jsx(Re,{}),color:"#4caf50"}].map((t,a)=>e.jsx(H,{item:!0,xs:12,sm:4,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2,p:2,borderRadius:3,bgcolor:"rgba(255,255,255,0.2)",backdropFilter:"blur(10px)"},children:[e.jsx(v,{sx:{bgcolor:"white",color:t.color,width:56,height:56},children:t.icon}),e.jsxs(i,{children:[e.jsx(o,{variant:"caption",sx:{opacity:.95,color:"white",fontWeight:600},children:t.label}),e.jsx(o,{variant:"h5",fontWeight:700,color:"white",children:t.value})]})]})},a))})]}),e.jsxs(pe,{elevation:0,sx:{borderRadius:4,border:"1px solid",borderColor:"divider"},children:[e.jsx(i,{sx:{borderBottom:1,borderColor:"divider",px:2},children:e.jsxs(xe,{value:u,onChange:(t,a)=>se(a),sx:{"& .MuiTab-root":{fontWeight:600,py:2,color:"text.secondary","&.Mui-selected":{color:"primary.main"}}},children:[e.jsx(w,{label:"All Requests"}),e.jsx(w,{label:"Pending"}),e.jsx(w,{label:"Approved"}),e.jsx(w,{label:"Rejected"})]})}),e.jsxs(i,{sx:{p:3,display:"flex",gap:2,flexWrap:"wrap",alignItems:"center",bgcolor:"#fafafa"},children:[e.jsx(A,{size:"small",placeholder:"Search vendor name or email...",value:j,onChange:t=>ee(t.target.value),InputProps:{startAdornment:e.jsx(We,{sx:{mr:1,color:"text.secondary"}})},sx:{flexGrow:1,maxWidth:400,bgcolor:"white","& .MuiInputBase-input":{color:"text.primary"}}}),e.jsxs(ue,{size:"small",sx:{minWidth:160,bgcolor:"white"},children:[e.jsx(me,{sx:{color:"text.secondary"},children:"Module"}),e.jsxs(je,{value:g,label:"Module",onChange:t=>te(t.target.value),sx:{color:"text.primary"},children:[e.jsx(U,{value:"all",children:"All Modules"}),ae.map(t=>e.jsx(U,{value:t.title,children:t.title},t._id))]})]})]}),e.jsxs(ge,{children:[e.jsx(fe,{sx:{bgcolor:"#f8f9fc"},children:e.jsxs(S,{children:[e.jsx(l,{sx:{fontWeight:700,color:"text.primary"},children:"Vendor Details"}),e.jsx(l,{sx:{fontWeight:700,color:"text.primary"},children:"Plan Info"}),e.jsx(l,{sx:{fontWeight:700,color:"text.primary"},children:"Request Date"}),e.jsx(l,{sx:{fontWeight:700,color:"text.primary"},children:"Status"}),e.jsx(l,{align:"right",sx:{fontWeight:700,color:"text.primary"},children:"Management"})]})}),e.jsx(ye,{children:re?e.jsx(S,{children:e.jsx(l,{colSpan:5,align:"center",sx:{py:10},children:e.jsx(G,{})})}):_.length===0?e.jsx(S,{children:e.jsxs(l,{colSpan:5,align:"center",sx:{py:10},children:[e.jsx(o,{color:"text.secondary",variant:"h6",children:"No requests found"}),e.jsx(o,{color:"text.secondary",variant:"body2",children:"Try adjusting your filters"})]})}):_.map(t=>e.jsxs(S,{hover:!0,children:[e.jsx(l,{children:e.jsxs(m,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(v,{src:t.userAvatar,sx:{width:45,height:45,bgcolor:"primary.light",color:"primary.main",fontWeight:700},children:t.userName[0]}),e.jsxs(i,{children:[e.jsx(o,{variant:"body2",fontWeight:700,color:"text.primary",children:t.userName}),e.jsx(o,{variant:"caption",color:"text.secondary",children:t.userEmail})]})]})}),e.jsxs(l,{children:[e.jsx(o,{variant:"body2",fontWeight:600,color:"text.primary",children:t.planName}),e.jsxs(m,{direction:"row",spacing:1,sx:{mt:.5},children:[e.jsx(N,{size:"small",label:`₹${t.planPrice}`,sx:{height:20,bgcolor:D(d.palette.primary.main,.1),color:"primary.main",fontWeight:700,"& .MuiChip-label":{color:"primary.main"}}}),e.jsx(N,{size:"small",label:`${t.planDuration} Days`,variant:"outlined",sx:{height:20,"& .MuiChip-label":{color:"text.primary"}}})]})]}),e.jsx(l,{children:e.jsxs(m,{direction:"row",spacing:1,alignItems:"center",color:"text.secondary",children:[e.jsx(Se,{sx:{fontSize:14,color:"text.secondary"}}),e.jsx(o,{variant:"caption",color:"text.secondary",children:t.requestDate})]})}),e.jsx(l,{children:le(t.status)}),e.jsx(l,{align:"right",children:e.jsxs(m,{direction:"row",spacing:1,justifyContent:"flex-end",children:[e.jsx(be,{title:"View Info",children:e.jsx(J,{onClick:()=>W({open:!0,data:t}),size:"small",sx:{color:"text.primary"},children:e.jsx(Ce,{fontSize:"small"})})}),t.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"small",variant:"contained",disableElevation:!0,onClick:()=>I({open:!0,data:t}),startIcon:e.jsx(X,{}),sx:{borderRadius:2,textTransform:"none",fontWeight:700,color:"white"},children:"Pay & Approve"}),e.jsx(J,{color:"error",onClick:()=>f({open:!0,data:t,action:"reject"}),size:"small",children:e.jsx(V,{fontSize:"small"})})]})]})})]},t.id))})]})]}),e.jsxs(M,{open:p.open,onClose:()=>I({open:!1,data:null}),fullWidth:!0,maxWidth:"xs",PaperProps:{sx:{borderRadius:4}},children:[e.jsxs(z,{sx:{textAlign:"center",pt:4},children:[e.jsx(v,{sx:{m:"0 auto",bgcolor:D(d.palette.primary.main,.1),color:"primary.main",width:60,height:60,mb:2},children:e.jsx(X,{fontSize:"large"})}),e.jsx(o,{variant:"h5",fontWeight:800,color:"text.primary",children:"Confirm Payment"})]}),e.jsxs(q,{children:[e.jsxs(i,{sx:{bgcolor:"#f8f9fc",p:2,borderRadius:3,mb:3},children:[e.jsx(o,{variant:"caption",color:"text.secondary",fontWeight:600,children:"Total Payable Amount"}),e.jsxs(o,{variant:"h4",fontWeight:800,color:"primary.main",children:["₹",p.data?.planPrice]}),e.jsx(Q,{sx:{my:1.5}}),e.jsxs(o,{variant:"body2",fontWeight:600,color:"text.primary",children:[p.data?.planName," Plan"]}),e.jsxs(o,{variant:"caption",display:"block",color:"text.secondary",children:[p.data?.userName," (",p.data?.module,")"]})]}),e.jsx(A,{fullWidth:!0,multiline:!0,rows:3,label:"Note for Vendor",placeholder:"Add a comment about the approval...",value:y,onChange:t=>b(t.target.value),sx:{mt:1,"& .MuiInputBase-input":{color:"text.primary"}}})]}),e.jsxs(E,{sx:{p:3,pt:0},children:[e.jsx(x,{fullWidth:!0,onClick:()=>I({open:!1}),sx:{fontWeight:700,color:"text.primary"},children:"Cancel"}),e.jsx(x,{fullWidth:!0,variant:"contained",disableElevation:!0,onClick:()=>ie(p.data),disabled:$,sx:{py:1.5,borderRadius:3,fontWeight:700,color:"white"},children:$?e.jsx(G,{size:24,color:"inherit"}):`Pay ₹${p.data?.planPrice}`})]})]}),e.jsxs(M,{open:c.open,onClose:()=>W({open:!1}),fullWidth:!0,maxWidth:"sm",PaperProps:{sx:{borderRadius:4}},children:[e.jsx(z,{sx:{fontWeight:800,color:"text.primary"},children:"Application Overview"}),e.jsx(q,{children:c.data&&e.jsxs(m,{spacing:3,sx:{mt:1},children:[e.jsxs(i,{sx:{p:2,borderRadius:3,border:"1px solid #eee",bgcolor:"#fafafa"},children:[e.jsx(o,{variant:"caption",color:"primary.main",fontWeight:700,gutterBottom:!0,children:"VENDOR PROFILE"}),e.jsx(o,{variant:"h6",fontWeight:700,color:"text.primary",children:c.data.userName}),e.jsx(o,{variant:"body2",color:"text.secondary",children:c.data.userEmail}),e.jsx(o,{variant:"body2",color:"text.secondary",children:c.data.userPhone||"No Phone Contact"})]}),e.jsxs(i,{sx:{p:2,borderRadius:3,bgcolor:d.palette.primary.main,color:"white"},children:[e.jsx(o,{variant:"caption",sx:{color:"white",opacity:.9},fontWeight:700,children:"SELECTED PLAN"}),e.jsx(o,{variant:"h6",fontWeight:700,color:"white",children:c.data.planName}),e.jsxs(m,{direction:"row",spacing:2,sx:{mt:1},children:[e.jsxs(o,{variant:"h5",fontWeight:800,color:"white",children:["₹",c.data.planPrice]}),e.jsx(Q,{orientation:"vertical",flexItem:!0,sx:{bgcolor:"white",opacity:.3}}),e.jsxs(i,{children:[e.jsxs(o,{variant:"body2",fontWeight:700,color:"white",children:[c.data.planDuration," Days"]}),e.jsx(o,{variant:"caption",sx:{color:"white",opacity:.8},children:"Validity"})]})]})]}),c.data.adminNote&&e.jsxs(i,{sx:{p:2,borderRadius:3,bgcolor:"#fff8e1",border:"1px solid #ffe082"},children:[e.jsx(o,{variant:"caption",color:"#f57c00",fontWeight:700,children:"ADMIN COMMENTS"}),e.jsx(o,{variant:"body2",color:"text.primary",children:c.data.adminNote})]})]})}),e.jsx(E,{sx:{p:3},children:e.jsx(x,{onClick:()=>W({open:!1}),fullWidth:!0,variant:"outlined",sx:{borderRadius:3,fontWeight:700,color:"text.primary",borderColor:"divider"},children:"Close View"})})]}),e.jsxs(M,{open:P.open&&P.action==="reject",onClose:()=>f({open:!1,data:null,action:""}),fullWidth:!0,maxWidth:"xs",PaperProps:{sx:{borderRadius:4}},children:[e.jsxs(z,{sx:{textAlign:"center",pt:4},children:[e.jsx(v,{sx:{m:"0 auto",bgcolor:D(d.palette.error.main,.1),color:"error.main",width:60,height:60,mb:2},children:e.jsx(V,{fontSize:"large"})}),e.jsx(o,{variant:"h5",fontWeight:800,color:"text.primary",children:"Reject Request"})]}),e.jsxs(q,{children:[e.jsx(o,{variant:"body2",color:"text.secondary",sx:{mb:2,textAlign:"center"},children:"Are you sure you want to reject this subscription request?"}),e.jsx(A,{fullWidth:!0,multiline:!0,rows:3,label:"Reason for Rejection",placeholder:"Provide a reason for rejecting this request...",value:y,onChange:t=>b(t.target.value),sx:{"& .MuiInputBase-input":{color:"text.primary"}}})]}),e.jsxs(E,{sx:{p:3,pt:0},children:[e.jsx(x,{fullWidth:!0,onClick:()=>{f({open:!1,data:null,action:""}),b("")},sx:{fontWeight:700,color:"text.primary"},children:"Cancel"}),e.jsx(x,{fullWidth:!0,variant:"contained",color:"error",disableElevation:!0,onClick:async()=>{try{const t=R();await fetch(`https://api.bookmyevent.ae/api/admin/subscription/requests/${P.data.id}/reject`,{method:"PUT",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({adminNote:y})}),T(),f({open:!1,data:null,action:""}),b("")}catch{alert("Reject failed")}},sx:{py:1.5,borderRadius:3,fontWeight:700,color:"white"},children:"Reject Request"})]})]})]})};export{Ee as default};
