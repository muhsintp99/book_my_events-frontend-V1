import{r,j as e,B as l,T as d,g as i,d as R,C as O,F as Q,I as V,H as Y,M as W,A as _,Z as Oe}from"./index-Bv9CUdV4.js";import{C as pe}from"./CloudUpload-DJGsC8MK.js";import{F as De}from"./FormControlLabel-B4kLMrdC.js";import{C as Te}from"./Checkbox-DR-pBy9q.js";function He(){const[he,D]=r.useState(!1),[ge,fe]=r.useState(""),[xe,be]=r.useState("success"),[M,w]=r.useState(!1),[ve,X]=r.useState(!0),[je,ee]=r.useState(!0),S=localStorage.getItem("moduleDbId"),[m,ye]=r.useState({accountHolderName:"",bankName:"",accountNumber:"",ifscCode:"",branchName:"",accountType:"savings",upiId:""}),A=t=>a=>{ye({...m,[t]:a.target.value})},[we,T]=r.useState(!0),[z,I]=r.useState([]),[N,B]=r.useState(""),[j,te]=r.useState(!1),q=r.useRef(null),g=r.useRef(null),Z=r.useRef(null),[C,se]=r.useState(!1),[f,Ne]=r.useState(null),H="AIzaSyAfLUm1kPmeMkHh1Hr5nbgNpQJOsNa7B78",[s,v]=r.useState({firstName:"",lastName:"",email:"",phone:"",storeName:"",storeAddress:{street:"",city:"",state:"",zipCode:"",fullAddress:""},minimumDeliveryTime:"",maximumDeliveryTime:"",zone:"",module:S||"",latitude:"",longitude:"",ownerFirstName:"",ownerLastName:"",ownerPhone:"",ownerEmail:"",status:"pending",reviewedBy:"",reviewedAt:"",rejectionReason:"",adminNotes:"",isActive:!0,approvedProvider:""}),[ae,re]=r.useState([]),[U,ne]=r.useState([]),[Ce,oe]=r.useState([]),[Se,le]=r.useState(""),[$,ie]=r.useState(null),[J,de]=r.useState(null),[E,ce]=r.useState({logo:null,coverImage:null}),P="https://api.bookmyevent.ae/api";r.useEffect(()=>{(async()=>{if(!s.module){I([]),T(!1);return}try{T(!0);const n=await(await fetch(`${P}/subscription/plan/module/${s.module}`)).json();n&&n.success&&Array.isArray(n.plans)?I(n.plans):Array.isArray(n)?I(n):n&&Array.isArray(n.data)?I(n.data):I([])}catch(a){console.error("Error fetching plans",a),I([])}finally{T(!1)}})()},[s.module,P]),r.useEffect(()=>{if(window.google&&window.google.maps){se(!0);return}const t=document.createElement("script");return t.src=`https://maps.googleapis.com/maps/api/js?key=${H}&libraries=places`,t.async=!0,t.defer=!0,t.onload=()=>se(!0),document.head.appendChild(t),()=>{document.head.contains(t)&&document.head.removeChild(t)}},[H]),r.useEffect(()=>{C&&window.google?.maps&&Ae()},[C]);const Ae=r.useCallback(()=>{if(!window.google||!q.current||!C)return;const t=s.latitude&&s.longitude?parseFloat(s.latitude):25.2048,a=s.latitude&&s.longitude?parseFloat(s.longitude):55.2708,n={lat:t,lng:a},o=new window.google.maps.Map(q.current,{zoom:12,center:n});o.addListener("click",c=>{const p=c.latLng.lat(),b=c.latLng.lng();v(u=>({...u,latitude:p.toString(),longitude:b.toString()})),g.current&&g.current.setMap(null),g.current=new window.google.maps.Marker({position:{lat:p,lng:b},map:o}),new window.google.maps.Geocoder().geocode({location:{lat:p,lng:b}},(u,y)=>{if(y==="OK"&&u[0]){const Me=u[0].address_components||[],F=K=>{const me=Me.find(Re=>Re.types.includes(K));return me?me.long_name:""};v(K=>({...K,storeAddress:{street:F("route"),city:F("locality")||F("administrative_area_level_2")||"",state:F("administrative_area_level_1")||"",zipCode:F("postal_code")||"",fullAddress:u[0].formatted_address||""},latitude:p.toString(),longitude:b.toString()})),h("Location set and address auto-filled!","success")}else h("Location set, but could not determine address.","info")})}),Ne(o)},[C,s.latitude,s.longitude]);r.useEffect(()=>{if(!C||!f||!Z.current||!window.google)return;const t=new window.google.maps.places.Autocomplete(Z.current,{fields:["place_id","geometry","name","formatted_address","address_components"]}),a=t.addListener("place_changed",()=>{const n=t.getPlace();if(!n.geometry?.location)return;const o=n.geometry.location;n.geometry.viewport?f.fitBounds(n.geometry.viewport):(f.setCenter(o),f.setZoom(17)),g.current&&g.current.setMap(null),g.current=new window.google.maps.Marker({position:o,map:f});const c=n.address_components||[],p=b=>{const L=c.find(u=>u.types.includes(b));return L?L.long_name:""};v(b=>({...b,latitude:o.lat().toString(),longitude:o.lng().toString(),storeAddress:{street:p("route")||"",city:p("locality")||p("administrative_area_level_2")||"",state:p("administrative_area_level_1")||"",zipCode:p("postal_code")||"",fullAddress:n.formatted_address||n.name||""}})),h("Location selected!","success")});return()=>{a&&a.remove&&a.remove()}},[C,f]),r.useEffect(()=>{if(!f||!s.latitude||!s.longitude)return;const t={lat:parseFloat(s.latitude),lng:parseFloat(s.longitude)};f.setCenter(t),f.setZoom(12),g.current?g.current.setPosition(t):g.current=new window.google.maps.Marker({position:t,map:f})},[s.latitude,s.longitude,f]),r.useEffect(()=>{Ie(),Pe()},[]);const Ie=async()=>{try{X(!0);const a=await(await fetch(`${P}/zones`)).json();re(a.data||[])}catch(t){console.error("Error fetching zones",t),h("Error fetching zones","error"),re([])}finally{X(!1)}},Pe=async()=>{try{ee(!0);const a=await(await fetch(`${P}/modules`)).json();oe(Array.isArray(a)?a:a.data||[]);const n=Array.isArray(a)?a:a.data||[],o=S?n.filter(c=>c._id===S):n;ne(o),S&&o.length&&v(c=>({...c,module:S}))}catch(t){console.error("Error fetching modules:",t),ne([]),oe([])}finally{ee(!1)}},h=(t,a="success")=>{fe(t),be(a),D(!0)},x=t=>a=>v({...s,[t]:a.target.value}),k=t=>a=>v({...s,storeAddress:{...s.storeAddress,[t]:a.target.value}}),Le=t=>{const a=t.target.value;le(a),v({...s,zone:a})},_e=t=>v({...s,module:t.target.value}),ue=(t,a)=>{const n=t.target.files[0];if(!n)return;ce({...E,[a]:n});const o=new FileReader;o.onload=c=>{a==="logo"&&ie(c.target.result),a==="coverImage"&&de(c.target.result)},o.readAsDataURL(n)},Ee=()=>{const t=[];return s.firstName.trim()||t.push("First name is required"),s.lastName.trim()||t.push("Last name is required"),s.email.trim()||t.push("Email is required"),s.ownerFirstName.trim()||t.push("Owner first name is required"),s.ownerLastName.trim()||t.push("Owner last name is required"),s.ownerEmail.trim()||t.push("Owner email is required"),s.ownerEmail&&!/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,})+$/.test(s.ownerEmail)&&t.push("Owner email is invalid"),s.module||t.push("Module is required"),!j&&!N&&t.push("Subscription plan is required (or enable Free Trial)"),t},ke=async()=>{const t=Ee();if(t.length){h(t.join(", "),"error");return}try{w(!0);const a=new FormData;a.append("firstName",s.firstName),a.append("lastName",s.lastName),a.append("email",s.email),a.append("phone",s.phone),a.append("role","vendor"),a.append("storeName",s.storeName),a.append("accountHolderName",m.accountHolderName),a.append("bankName",m.bankName),a.append("accountNumber",m.accountNumber),a.append("ifscCode",m.ifscCode),a.append("branchName",m.branchName),a.append("upiId",m.upiId),a.append("accountType",m.accountType),a.append("storeAddress",JSON.stringify(s.storeAddress)),a.append("minimumDeliveryTime",s.minimumDeliveryTime),a.append("maximumDeliveryTime",s.maximumDeliveryTime),a.append("latitude",s.latitude),a.append("longitude",s.longitude),a.append("ownerFirstName",s.ownerFirstName),a.append("ownerLastName",s.ownerLastName),a.append("ownerPhone",s.ownerPhone),a.append("ownerEmail",s.ownerEmail),a.append("module",s.module),a.append("zone",s.zone),a.append("status",s.status),a.append("reviewedBy",s.reviewedBy),a.append("reviewedAt",s.reviewedAt),a.append("rejectionReason",s.rejectionReason),a.append("adminNotes",s.adminNotes),a.append("isActive",s.isActive),a.append("approvedProvider",s.approvedProvider),a.append("isFreeTrial",j),!j&&N&&a.append("subscriptionPlan",N),E.logo&&a.append("logo",E.logo),E.coverImage&&a.append("coverImage",E.coverImage);const n=await fetch(`${P}/auth/register`,{method:"POST",body:a});let o;try{o=await n.json()}catch(y){console.error("Failed to parse response:",y),h("Invalid response from server","error"),w(!1);return}if(console.log("=== REGISTRATION RESPONSE ==="),console.log("Status:",n.status),console.log("Response:",JSON.stringify(o,null,2)),console.log("============================"),!n.ok){h(o.message||"Failed to add provider","error"),w(!1);return}const c=o.providerId||o.userId||o._id||o.id||o.data&&(o.data.providerId||o.data._id)||o.user&&(o.user._id||o.user.id);if(console.log("Extracted providerId:",c),j){h("Provider added successfully with Free Trial!","success"),setTimeout(()=>{G()},2e3),w(!1);return}if(!c){console.error("=== PROVIDER ID NOT FOUND ==="),console.error("Full response:",JSON.stringify(o,null,2)),console.error("============================");const y=JSON.stringify(o).substring(0,200);h(`Provider created but ID not found in response. Check console for details. Response preview: ${y}...`,"error"),setTimeout(()=>{G()},5e3),w(!1);return}const p=z.find(y=>(y._id||y.id)===N),b=p&&(p.price||p.amount)||0,L=await fetch(`${P}/payment/create-subscription-payment`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({providerId:c,planId:N,amount:b,customerEmail:s.email,customerPhone:s.phone||"9999999999"})}),u=await L.json();if(!L.ok){h("Provider created but payment session failed: "+(u.message||"Unknown error"),"error"),w(!1);return}u.success&&u.payment_links&&u.payment_links.web?(h("Redirecting to payment page...","info"),localStorage.setItem("pendingPayment",JSON.stringify({providerId:c,planId:N,orderId:u.order_id,sessionId:u.id})),setTimeout(()=>{window.location.href=u.payment_links.web},1500)):h("Payment link not available. Please contact admin.","error")}catch(a){console.error("Error:",a),h("Error processing request: "+a.message,"error")}finally{w(!1)}},G=()=>{v({firstName:"",lastName:"",email:"",phone:"",storeName:"",storeAddress:{street:"",city:"",state:"",zipCode:"",fullAddress:""},minimumDeliveryTime:"",maximumDeliveryTime:"",zone:"",module:S||"",latitude:"",longitude:"",ownerFirstName:"",ownerLastName:"",ownerPhone:"",ownerEmail:"",status:"pending",reviewedBy:"",reviewedAt:"",rejectionReason:"",adminNotes:"",isActive:!0,approvedProvider:""}),le(""),ie(null),de(null),ce({logo:null,coverImage:null}),B(""),te(!1),g.current&&(g.current.setMap(null),g.current=null)},Fe=()=>{if(!s.module)return"No module selected";const t=Ce.find(a=>a._id===s.module);return t?t.title:"Unknown module"},We={"& .MuiOutlinedInput-root":{"&.Mui-focused .MuiOutlinedInput-notchedOutline":{borderColor:"#E15B65"},"&:hover .MuiOutlinedInput-notchedOutline":{borderColor:"#E15B65"}}};return e.jsxs(l,{sx:{p:3,backgroundColor:"#f9f9f9",borderRadius:2},children:[e.jsx(d,{variant:"h4",fontWeight:"bold",sx:{mb:3},children:"Add Provider"}),e.jsxs(l,{sx:{mb:3},children:[e.jsx(d,{variant:"h5",fontWeight:"bold",sx:{mb:2},children:"Store Information"}),e.jsx(i,{fullWidth:!0,label:"Store Name",variant:"outlined",value:s.storeName,onChange:x("storeName"),sx:{mb:2}})]}),$&&e.jsxs(l,{sx:{mb:2,p:2,border:"1px solid #ddd",borderRadius:"4px"},children:[e.jsx(d,{variant:"subtitle2",sx:{mb:1},children:"Selected Logo:"}),e.jsx("img",{src:$,alt:"Logo",style:{maxWidth:"100px",maxHeight:"200px",objectFit:"contain"}})]}),e.jsx(l,{sx:{border:"1px dashed grey",p:2,textAlign:"center",mb:2},children:e.jsxs(R,{variant:"outlined",component:"label",startIcon:e.jsx(pe,{}),sx:{width:"100%"},children:[$?"Change Logo":"Upload Logo",e.jsx("input",{type:"file",hidden:!0,accept:"image/jpeg,image/png",onChange:t=>ue(t,"logo")})]})}),J&&e.jsxs(l,{sx:{mb:2,p:2,border:"1px solid #ddd",borderRadius:"4px"},children:[e.jsx(d,{variant:"subtitle2",sx:{mb:1},children:"Selected Cover:"}),e.jsx("img",{src:J,alt:"Cover",style:{maxWidth:"100%",maxHeight:"200px",objectFit:"contain"}})]}),e.jsx(l,{sx:{border:"1px dashed grey",p:2,textAlign:"center",mb:2},children:e.jsxs(R,{variant:"outlined",component:"label",startIcon:e.jsx(pe,{}),sx:{width:"100%"},children:[J?"Change Cover":"Upload Cover",e.jsx("input",{type:"file",hidden:!0,accept:"image/jpeg,image/png",onChange:t=>ue(t,"coverImage")})]})}),e.jsxs(l,{sx:{mb:3},children:[e.jsx(d,{variant:"h5",fontWeight:"bold",sx:{mb:2},children:"User Information"}),e.jsxs(l,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:2,mb:2},children:[e.jsx(i,{fullWidth:!0,label:"First Name *",required:!0,variant:"outlined",value:s.firstName,onChange:x("firstName")}),e.jsx(i,{fullWidth:!0,label:"Last Name *",required:!0,variant:"outlined",value:s.lastName,onChange:x("lastName")})]}),e.jsx(i,{fullWidth:!0,label:"Email *",required:!0,variant:"outlined",value:s.email,onChange:x("email"),sx:{mb:2}}),e.jsx(i,{fullWidth:!0,label:"Mobile Number",variant:"outlined",value:s.phone,onChange:x("phone"),placeholder:"Enter mobile number",sx:{mb:2}})]}),e.jsxs(l,{sx:{mb:3},children:[e.jsx(d,{variant:"h5",fontWeight:"bold",sx:{mb:2},children:"Location"}),e.jsxs(l,{sx:{mb:2},children:[je?e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(O,{size:20}),e.jsx(d,{variant:"body2",children:"Loading modules..."})]}):U.length?e.jsxs(Q,{fullWidth:!0,variant:"outlined",children:[e.jsx(V,{id:"module-select-label",children:"Module *"}),e.jsx(Y,{labelId:"module-select-label",value:s.module,onChange:_e,label:"Module *",disabled:U.length===1,children:U.map(t=>e.jsx(W,{value:t._id,children:t.title},t._id))})]}):e.jsx(_,{severity:"warning",children:"No modules available. Please configure modules first."}),s.module&&e.jsx(l,{sx:{mt:1,p:1.5,bgcolor:"#e3f2fd",borderRadius:1},children:e.jsxs(d,{variant:"body2",color:"primary",children:["Selected Module: ",e.jsx("strong",{children:Fe()})]})})]}),e.jsx(l,{sx:{mb:2},children:ve?e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(O,{size:20}),e.jsx(d,{variant:"body2",children:"Loading zones..."})]}):ae.length?e.jsxs(Q,{fullWidth:!0,variant:"outlined",children:[e.jsx(V,{id:"zone-select-label",children:"Zone"}),e.jsxs(Y,{labelId:"zone-select-label",value:Se,onChange:Le,label:"Zone",children:[e.jsx(W,{value:"",children:e.jsx("em",{children:"Select Zone"})}),ae.map(t=>e.jsx(W,{value:t._id,children:t.name},t._id))]})]}):e.jsx(_,{severity:"info",children:"No zones available"})}),e.jsxs(l,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:2,mb:2},children:[e.jsx(i,{fullWidth:!0,label:"Street",variant:"outlined",value:s.storeAddress.street,onChange:k("street")}),e.jsx(i,{fullWidth:!0,label:"City",variant:"outlined",value:s.storeAddress.city,onChange:k("city")})]}),e.jsxs(l,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:2,mb:2},children:[e.jsx(i,{fullWidth:!0,label:"State",variant:"outlined",value:s.storeAddress.state,onChange:k("state")}),e.jsx(i,{fullWidth:!0,label:"Zip Code",variant:"outlined",value:s.storeAddress.zipCode,onChange:k("zipCode")})]}),e.jsx(i,{fullWidth:!0,label:"Full Address",variant:"outlined",value:s.storeAddress.fullAddress,onChange:k("fullAddress"),sx:{mb:2}}),e.jsx(i,{fullWidth:!0,label:"Search Location",inputRef:Z,variant:"outlined",placeholder:"Enter a location",sx:{mb:2,...We}}),C&&H?e.jsxs(e.Fragment,{children:[e.jsx(d,{variant:"body2",color:"text.secondary",sx:{mb:1},children:"Click on the map below to select a location"}),e.jsx(l,{ref:q,sx:{height:300,width:"100%",borderRadius:1,border:"1px solid #ddd",mb:2}})]}):e.jsx(l,{sx:{height:300,display:"flex",alignItems:"center",justifyContent:"center",border:"1px solid #ddd",borderRadius:1,mb:2},children:e.jsx(d,{variant:"body2",color:"text.secondary",children:"Map loading..."})}),e.jsxs(l,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:2,mb:2},children:[e.jsx(i,{fullWidth:!0,label:"Latitude",type:"number",inputProps:{step:"0.0001"},value:s.latitude,onChange:x("latitude")}),e.jsx(i,{fullWidth:!0,label:"Longitude",type:"number",inputProps:{step:"0.0001"},value:s.longitude,onChange:x("longitude")})]})]}),e.jsxs(l,{sx:{mb:3},children:[e.jsx(d,{variant:"h5",fontWeight:"bold",sx:{mb:2},children:"Owner Information"}),e.jsxs(l,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:2,mb:2},children:[e.jsx(i,{fullWidth:!0,label:"Owner First Name *",required:!0,variant:"outlined",value:s.ownerFirstName,onChange:x("ownerFirstName")}),e.jsx(i,{fullWidth:!0,label:"Owner Last Name *",required:!0,variant:"outlined",value:s.ownerLastName,onChange:x("ownerLastName")})]}),e.jsx(i,{fullWidth:!0,label:"Owner Email *",required:!0,variant:"outlined",value:s.ownerEmail,onChange:x("ownerEmail"),sx:{mb:2}}),e.jsx(i,{fullWidth:!0,label:"Owner Phone",variant:"outlined",value:s.ownerPhone,onChange:x("ownerPhone"),sx:{mb:2}})]}),e.jsxs(l,{sx:{mb:3,mt:4,p:2,borderRadius:2,border:"1px solid #ddd",background:"#fafafa"},children:[e.jsx(d,{variant:"h5",fontWeight:"bold",sx:{mb:2},children:"Subscription Information"}),e.jsx(l,{sx:{mb:2},children:e.jsx(De,{control:e.jsx(Te,{size:"small",checked:j,onChange:t=>{te(t.target.checked),t.target.checked&&B("")}}),label:"Enable Free Trial (No Payment Required)"})}),!j&&e.jsx(e.Fragment,{children:we?e.jsxs(l,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(O,{size:20}),e.jsx(d,{children:"Loading plans..."})]}):z.length>0?e.jsxs(Q,{fullWidth:!0,children:[e.jsx(V,{children:"Subscription Plan *"}),e.jsxs(Y,{label:"Subscription Plan *",value:N,onChange:t=>B(t.target.value),children:[e.jsx(W,{value:"",children:e.jsx("em",{children:"Select Subscription Plan"})}),z.map(t=>e.jsx(W,{value:t._id||t.id,children:e.jsxs(l,{sx:{display:"flex",flexDirection:"column"},children:[e.jsx(d,{sx:{fontWeight:"bold"},children:t.name||t.title}),e.jsxs(d,{sx:{fontSize:"14px",color:"#555"},children:["Price: â‚¹",t.price??t.amount??0," / ",t.duration||"month"]})]})},t._id||t.id))]})]}):e.jsx(_,{severity:"info",children:"No subscription plans available for this module"})}),j&&e.jsx(_,{severity:"info",sx:{mt:2},children:"Free trial enabled. Provider will have limited access until subscription is purchased."})]}),e.jsxs(l,{sx:{mb:3,mt:4,p:2,borderRadius:2,border:"1px solid #ddd",background:"#fafafa"},children:[e.jsx(d,{variant:"h5",fontWeight:"bold",sx:{mb:2},children:"Bank Details"}),e.jsx(_,{severity:"info",sx:{mb:2},children:"Please provide correct bank details. These details will be used for vendor settlements and payouts."}),e.jsxs(l,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx(i,{fullWidth:!0,label:"Account Holder Name",value:m.accountHolderName,onChange:A("accountHolderName")}),e.jsx(i,{fullWidth:!0,label:"Bank Name",value:m.bankName,onChange:A("bankName")})]}),e.jsxs(l,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx(i,{fullWidth:!0,label:"Account Number",value:m.accountNumber,onChange:A("accountNumber")}),e.jsx(i,{fullWidth:!0,label:"IFSC Code",value:m.ifscCode,onChange:A("ifscCode")})]}),e.jsxs(l,{sx:{display:"flex",gap:2},children:[e.jsx(i,{fullWidth:!0,label:"Branch Name",value:m.branchName,onChange:A("branchName")}),e.jsx(i,{fullWidth:!0,label:"UPI ID",value:m.upiId,onChange:A("upiId")})]})]}),e.jsxs(l,{sx:{display:"flex",justifyContent:{xs:"center",sm:"flex-end"},gap:2,mt:3},children:[e.jsx(R,{variant:"outlined",onClick:G,disabled:M,children:"Reset"}),e.jsx(R,{variant:"contained",color:"primary",onClick:ke,disabled:M,startIcon:M?e.jsx(O,{size:20,color:"inherit"}):null,children:M?"Processing...":j?"Submit":"Proceed to Payment"})]}),e.jsx(Oe,{open:he,autoHideDuration:6e3,onClose:()=>D(!1),anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(_,{onClose:()=>D(!1),severity:xe,sx:{width:"100%"},children:ge})})]})}export{He as default};
