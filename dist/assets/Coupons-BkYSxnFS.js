import{r,u as je,e as fe,a as ye,j as e,B,S as v,C as E,T as b,Z as J,A as Y,d as u,_ as Q,$ as V,a0 as X,g as m,H as G,M as C,a1 as K,aM as Ce,K as De,J as ve,N as be,Q as Se,U as O,V as s,W as Pe,a3 as Te,y as Z,c as ee,X as we,Y as ke}from"./index-CgvkLXhQ.js";const w="https://api.bookmyevent.ae/api",$e=()=>{const[k,L]=r.useState([]),[te,N]=r.useState(!1),[g,I]=r.useState(!1),[se,U]=r.useState(null),[l,j]=r.useState(!1),[f,i]=r.useState(null),[A,S]=r.useState(null),[y,ne]=r.useState(""),[c,R]=r.useState(1),[D,ae]=r.useState({currentPage:1,totalPages:1,totalItems:0,itemsPerPage:10}),[n,z]=r.useState({title:"",type:"",code:"",totalUses:"",startDate:"",expireDate:"",discountType:"",minPurchase:"",discount:"",maxDiscount:""}),[ie,$]=r.useState(!1),[F,_]=r.useState(null),re=je(),le=fe(re.breakpoints.down("sm")),q=ye(),P=()=>localStorage.getItem("token")||sessionStorage.getItem("token"),oe=()=>{const t=localStorage.getItem("user")||sessionStorage.getItem("user");if(!t)return null;try{return JSON.parse(t).role}catch(a){return console.error("Error parsing user data:",a),null}},T=async(t=1,a="")=>{const o=P();if(!o){i("You are not authenticated. Please log in.");return}j(!0),i(null);try{const x=`${w}/coupons?page=${t}&limit=10&search=${encodeURIComponent(a)}`,p=await fetch(x,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`}}),d=await p.json();if(p.status===401){i("Session expired. Please log in again.");return}if(p.status===403){i("Access denied. You don't have permission to view coupons.");return}if(!p.ok)throw new Error(d.message||`Server error: ${p.status}`);if(d.success&&d.data&&d.data.coupons)L(d.data.coupons),ae(d.pagination||{currentPage:t,totalPages:Math.ceil(d.data.coupons.length/10)||1,totalItems:d.data.coupons.length,itemsPerPage:10}),d.data.coupons.length===0&&i("No coupons found. Create a new one using 'Add New Coupon'.");else throw new Error("Invalid response format")}catch(x){console.error("Fetch error:",x),i(x.message||"Failed to fetch coupons."),L([])}finally{j(!1)}};r.useEffect(()=>{const t=oe();if(!P()){i("You are not authenticated. Please log in.");return}if(!["superadmin","admin","vendor"].includes(t)){i("Access denied. Admin, Superadmin, or Vendor role required.");return}T(c,y)},[c,y]);const W=(t=null)=>{t?(I(!0),U(t),z({title:t.title,type:t.type,code:t.code,totalUses:t.totalUses||"",startDate:t.startDate?t.startDate.split("T")[0]:"",expireDate:t.expireDate?t.expireDate.split("T")[0]:"",discountType:t.discountType||"",minPurchase:t.minPurchase||"",discount:t.discount||"",maxDiscount:t.maxDiscount||""})):(I(!1),U(null),z({title:"",type:"",code:"",totalUses:"",startDate:"",expireDate:"",discountType:"",minPurchase:"",discount:"",maxDiscount:""})),N(!0)},M=()=>{N(!1),I(!1),U(null)},ce=async()=>{const t=P();if(t){if(!n.title||!n.code||!n.type||!n.discount||!n.expireDate){i("Please fill all required fields: Title, Code, Type, Discount, Expire Date");return}j(!0);try{const a=g?`${w}/coupons/${se._id}`:`${w}/coupons`,o=g?"PUT":"POST",x={...n,code:n.code.toUpperCase().trim(),totalUses:parseInt(n.totalUses)||null,minPurchase:parseFloat(n.minPurchase)||0,discount:parseFloat(n.discount)||0,maxDiscount:n.maxDiscount?parseFloat(n.maxDiscount):null},p=await fetch(a,{method:o,headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(x)}),d=await p.json();if(p.status===401){i("Session expired. Please log in again.");return}if(!p.ok)throw new Error(d.message||`Failed to ${g?"update":"create"} coupon`);S(d.message||`Coupon ${g?"updated":"created"} successfully!`),M(),T(c,y)}catch(a){i(a.message||"Operation failed.")}finally{j(!1)}}},de=t=>{_(t),$(!0)},ue=async()=>{const t=P();if(!(!t||!F)){j(!0);try{const a=await fetch(`${w}/coupons/${F._id}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}}),o=await a.json();if(!a.ok)throw new Error(o.message||"Failed to delete coupon");S("Coupon deleted successfully!"),$(!1),_(null),T(c,y)}catch(a){i(a.message||"Failed to delete coupon")}finally{j(!1)}}},he=async t=>{const a=P();if(a){j(!0);try{const o=await fetch(`${w}/coupons/${t._id}/toggle`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({isActive:!t.isActive})}),x=await o.json();if(!o.ok)throw new Error(x.message||"Failed to update status");S(`Coupon ${t.isActive?"deactivated":"activated"}!`),T(c,y)}catch(o){i(o.message||"Failed to update status")}finally{j(!1)}}},h=t=>{const{name:a,value:o}=t.target;z(x=>({...x,[a]:o}))},xe=t=>{ne(t.target.value),R(1)},H=t=>{R(t)},pe=()=>T(c,y),me=()=>q("/login"),ge=()=>q("/dashboard");return l&&k.length===0?e.jsx(B,{p:2,display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsxs(v,{alignItems:"center",spacing:2,children:[e.jsx(E,{}),e.jsx(b,{children:"Loading coupons..."})]})}):e.jsxs(B,{p:2,children:[e.jsx(b,{variant:"h4",gutterBottom:!0,children:"Coupons Management"}),e.jsx(J,{open:!!f,autoHideDuration:6e3,onClose:()=>i(null),anchorOrigin:{vertical:"top",horizontal:"right"},children:e.jsx(Y,{severity:"error",onClose:()=>i(null),sx:{width:"100%"},action:e.jsxs(v,{direction:"row",spacing:1,children:[f?.includes("not authenticated")&&e.jsx(u,{color:"inherit",size:"small",onClick:me,children:"Login"}),f?.includes("Access denied")&&e.jsx(u,{color:"inherit",size:"small",onClick:ge,children:"Dashboard"}),f&&!f.includes("not authenticated")&&!f.includes("Access denied")&&e.jsx(u,{color:"inherit",size:"small",onClick:pe,children:"Retry"})]}),children:f})}),e.jsx(J,{open:!!A,autoHideDuration:4e3,onClose:()=>S(null),anchorOrigin:{vertical:"top",horizontal:"right"},children:e.jsx(Y,{severity:A?.includes("activated")?"success":"error",onClose:()=>S(null),sx:{bgcolor:A?.includes("activated")?"#4caf50":"#f44336",color:"#fff"},children:A})}),e.jsxs(Q,{open:te,onClose:M,maxWidth:"sm",fullWidth:!0,fullScreen:le,children:[e.jsx(V,{children:g?"Edit Coupon":"Add New Coupon"}),e.jsxs(X,{dividers:!0,children:[e.jsx(m,{fullWidth:!0,label:"Title *",name:"title",value:n.title,onChange:h,sx:{mb:2},required:!0}),e.jsxs(G,{fullWidth:!0,name:"type",value:n.type,onChange:h,displayEmpty:!0,sx:{mb:2},required:!0,children:[e.jsx(C,{value:"",children:"--Select coupon type *--"}),e.jsx(C,{value:"percentage",children:"Percentage"}),e.jsx(C,{value:"fixed_amount",children:"Fixed Amount"}),e.jsx(C,{value:"free_shipping",children:"Free Shipping"})]}),e.jsx(m,{fullWidth:!0,label:"Code *",name:"code",value:n.code,onChange:h,sx:{mb:2},required:!0,disabled:g,helperText:g?"Code cannot be changed":"Will be converted to uppercase"}),e.jsx(m,{fullWidth:!0,label:"Total Uses",name:"totalUses",type:"number",value:n.totalUses,onChange:h,sx:{mb:2},inputProps:{min:1}}),e.jsx(m,{fullWidth:!0,type:"date",label:"Start Date",name:"startDate",value:n.startDate,onChange:h,InputLabelProps:{shrink:!0},sx:{mb:2}}),e.jsx(m,{fullWidth:!0,type:"date",label:"Expire Date *",name:"expireDate",value:n.expireDate,onChange:h,InputLabelProps:{shrink:!0},sx:{mb:2},required:!0}),e.jsxs(G,{fullWidth:!0,name:"discountType",value:n.discountType,onChange:h,displayEmpty:!0,sx:{mb:2},children:[e.jsx(C,{value:"",children:"--Select discount type--"}),e.jsx(C,{value:"percentage",children:"Percentage (%)"}),e.jsx(C,{value:"amount",children:"Fixed Amount"})]}),e.jsx(m,{fullWidth:!0,label:"Min Purchase Amount",name:"minPurchase",type:"number",value:n.minPurchase,onChange:h,sx:{mb:2},inputProps:{min:0,step:.01}}),e.jsx(m,{fullWidth:!0,label:"Discount *",name:"discount",type:"number",value:n.discount,onChange:h,sx:{mb:2},required:!0,inputProps:{min:0,step:.01}}),e.jsx(m,{fullWidth:!0,label:"Max Discount Amount",name:"maxDiscount",type:"number",value:n.maxDiscount,onChange:h,sx:{mb:2},inputProps:{min:0,step:.01},helperText:"For percentage discounts"})]}),e.jsxs(K,{children:[e.jsx(u,{onClick:M,disabled:l,children:"Cancel"}),e.jsx(u,{variant:"contained",onClick:ce,disabled:l,children:l?e.jsx(E,{size:20}):g?"Update":"Create"})]})]}),e.jsxs(Q,{open:ie,onClose:()=>$(!1),children:[e.jsx(V,{children:"Delete Coupon"}),e.jsx(X,{children:e.jsxs(Ce,{children:["Are you sure you want to delete the coupon ",e.jsx("strong",{children:F?.title}),"? This action cannot be undone."]})}),e.jsxs(K,{children:[e.jsx(u,{onClick:()=>$(!1),disabled:l,children:"Cancel"}),e.jsx(u,{variant:"contained",color:"error",onClick:ue,disabled:l,children:l?e.jsx(E,{size:20}):"Delete"})]})]}),e.jsxs(De,{sx:{mt:2,width:"100%"},children:[e.jsxs(v,{direction:{xs:"column",sm:"row"},spacing:2,justifyContent:"space-between",alignItems:{xs:"stretch",sm:"center"},p:2,children:[e.jsx(u,{variant:"contained",onClick:()=>W(),disabled:l,children:"Add New Coupon"}),e.jsx(m,{label:"Search by title or code",variant:"outlined",size:"small",value:y,onChange:xe,sx:{maxWidth:{sm:300}},disabled:l})]}),l&&k.length>0&&e.jsx(B,{display:"flex",justifyContent:"center",p:2,children:e.jsx(E,{size:24})}),e.jsx(ve,{sx:{width:"100%",overflowX:"auto"},children:e.jsxs(be,{stickyHeader:!0,children:[e.jsx(Se,{children:e.jsxs(O,{children:[e.jsx(s,{children:"S#"}),e.jsx(s,{children:"Title"}),e.jsx(s,{children:"Code"}),e.jsx(s,{children:"Type"}),e.jsx(s,{children:"Total Uses"}),e.jsx(s,{children:"Used"}),e.jsx(s,{children:"Min Purchase"}),e.jsx(s,{children:"Max Discount"}),e.jsx(s,{children:"Discount"}),e.jsx(s,{children:"Discount Type"}),e.jsx(s,{children:"Start Date"}),e.jsx(s,{children:"Expire Date"}),e.jsx(s,{children:"Status"}),e.jsx(s,{align:"center",children:"Actions"})]})}),e.jsx(Pe,{children:k.length===0&&!l?e.jsx(O,{children:e.jsx(s,{colSpan:14,align:"center",children:e.jsxs(v,{spacing:2,alignItems:"center",py:4,children:[e.jsx(b,{variant:"h6",color:"textSecondary",children:"No coupons found"}),e.jsx(u,{variant:"outlined",onClick:()=>W(),children:"Create First Coupon"})]})})}):k.map((t,a)=>e.jsxs(O,{hover:!0,children:[e.jsx(s,{children:(c-1)*D.itemsPerPage+a+1}),e.jsx(s,{children:t.title}),e.jsx(s,{children:e.jsx(b,{variant:"body2",sx:{fontFamily:"monospace",fontWeight:"bold"},children:t.code})}),e.jsx(s,{children:t.type}),e.jsx(s,{children:t.totalUses||"Unlimited"}),e.jsx(s,{children:t.usedCount||0}),e.jsxs(s,{children:["$",t.minPurchase||0]}),e.jsx(s,{children:t.maxDiscount?`$${t.maxDiscount}`:"-"}),e.jsx(s,{children:t.discountType==="percentage"?`${t.discount}%`:`$${t.discount}`}),e.jsx(s,{children:t.discountType}),e.jsx(s,{children:t.startDate?new Date(t.startDate).toLocaleDateString():"-"}),e.jsx(s,{children:t.expireDate?new Date(t.expireDate).toLocaleDateString():"-"}),e.jsxs(s,{children:[e.jsx(Te,{checked:t.isActive,onChange:()=>he(t),color:"primary",size:"small"}),e.jsx(b,{variant:"caption",color:t.isActive?"success.main":"error.main",sx:{ml:1},children:t.isActive?"Active":"Inactive"})]}),e.jsx(s,{align:"center",children:e.jsxs(v,{direction:"row",spacing:.5,justifyContent:"center",children:[e.jsx(Z,{title:"Edit",children:e.jsx(ee,{size:"small",onClick:()=>W(t),color:"primary",children:e.jsx(we,{fontSize:"small"})})}),e.jsx(Z,{title:"Delete",children:e.jsx(ee,{size:"small",onClick:()=>de(t),color:"error",children:e.jsx(ke,{fontSize:"small"})})})]})})]},t._id))})]})}),D.totalPages>1&&e.jsxs(v,{direction:"row",spacing:2,justifyContent:"center",alignItems:"center",p:2,children:[e.jsx(u,{variant:"outlined",disabled:c===1||l,onClick:()=>H(c-1),children:"Previous"}),e.jsxs(b,{variant:"body2",children:["Page ",c," of ",D.totalPages,D.totalItems>0&&` (${D.totalItems} total)`]}),e.jsx(u,{variant:"outlined",disabled:c===D.totalPages||l,onClick:()=>H(c+1),children:"Next"})]})]})]})};export{$e as default};
