import{r as u,u as Se,e as Pe,a as we,j as e,B as F,S as k,C as R,T as g,Z as ee,A as te,d as m,_ as se,$ as ne,a0 as re,g as b,H as B,M as D,a1 as ae,K as Te,J as ke,N as Ae,Q as Ie,U as J,V as r,W as $e,o as Ee,y as oe,c as ie,X as Ue,Y as Ne}from"./index-CXSvRfrP.js";const _="https://api.bookmyevent.ae/api",ze=()=>{const[I,w]=u.useState([]),[le,O]=u.useState(!1),[ce,$]=u.useState(!1),[o,S]=u.useState(null),[j,L]=u.useState(!1),[p,E]=u.useState(!1),[U,Y]=u.useState(!1),[f,i]=u.useState(null),[q,A]=u.useState(null),[T,de]=u.useState(""),[y,H]=u.useState(1),[P,G]=u.useState({currentPage:1,totalPages:1,totalItems:0,itemsPerPage:10}),[n,N]=u.useState({title:"",type:"",code:"",totalUses:"",startDate:"",expireDate:"",discountType:"",minPurchase:"",discount:"",maxDiscount:"",isActive:!0}),ue=Se(),he=Pe(ue.breakpoints.down("sm")),Q=we(),W=()=>{const t=localStorage.getItem("token")||sessionStorage.getItem("token");return console.log("Retrieved token:",t?"Token exists":"No token found"),t},pe=()=>{const t=localStorage.getItem("user")||sessionStorage.getItem("user");if(!t)return console.log("No user data found in storage"),null;try{const s=JSON.parse(t);return console.log("User role:",s.role),s.role}catch(s){return console.error("Error parsing user data:",s),null}},z=async(t=1,s="")=>{const x=W();if(!x){i("You are not authenticated. Please log in."),console.log("No token found");return}E(!0),i(null);try{const l=`${_}/coupons?page=${t}&limit=10&search=${encodeURIComponent(s)}`;console.log("Fetching coupons from:",l);const d=await fetch(l,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${x}`}}),c=await d.text();console.log("API response status:",d.status,"Response text:",c);let a;try{a=JSON.parse(c)}catch{throw console.error("Invalid JSON response:",c),new Error("Server returned invalid response format. Please check server logs.")}if(d.status===401){i("Session expired. Please log in again."),console.log("401 Unauthorized - but staying on page");return}if(d.status===403){i("Access denied. You don't have permission to view coupons."),console.log("403 Forbidden - but staying on page");return}if(a.success===!1)throw console.error("API returned error:",a),new Error(a.message||"Failed to fetch coupons from server");if(!d.ok){console.error("Server error response:",a);const h=a.message||`Server error: ${d.status}`;throw new Error(h)}if(a.success!==!1){let h=[],C={currentPage:t,totalPages:1,totalItems:0,itemsPerPage:10};a.data&&a.data.coupons?(h=a.data.coupons,C=a.pagination||C):a.coupons?(h=a.coupons,C=a.pagination||C):Array.isArray(a)?h=a:a.data&&Array.isArray(a.data)&&(h=a.data),w(h),G(C),h.length===0&&i("No coupons found. You can create a new coupon using the 'Add New Coupon' button.")}else throw new Error(a.message||"Unknown error occurred while fetching coupons")}catch(l){console.error("Fetch error:",l);const d=l.message||"Network error occurred. Please check your connection and try again.";i(d),w([]),G({currentPage:1,totalPages:1,totalItems:0,itemsPerPage:10})}finally{E(!1)}};u.useEffect(()=>{const t=pe(),s=W();if(console.log("Initial check - Token:",s?"Exists":"Missing","Role:",t),!s){console.log("No token found - showing error but staying on page"),i("You are not authenticated. Please log in.");return}if(t!=="superadmin"&&t!=="admin"){console.log("Not admin or superadmin - showing error but staying on page"),i("Access denied. Admin or Superadmin role required.");return}console.log("Proceeding to fetch coupons - role check passed"),z(y,T)},[y,T]);const xe=()=>{L(!1),S(null),O(!0)},ge=t=>{L(!0),S(t);const s=x=>x?new Date(x).toISOString().split("T")[0]:"";N({title:t.title||"",type:t.type||"",code:t.code||"",totalUses:t.totalUses?.toString()||"",startDate:s(t.startDate),expireDate:s(t.expireDate),discountType:t.discountType||"",minPurchase:t.minPurchase?.toString()||"",discount:t.discount?.toString()||"",maxDiscount:t.maxDiscount?.toString()||"",isActive:t.isActive!==void 0?t.isActive:!0}),O(!0)},M=()=>{O(!1),L(!1),S(null),N({title:"",type:"",code:"",totalUses:"",startDate:"",expireDate:"",discountType:"",minPurchase:"",discount:"",maxDiscount:"",isActive:!0})},me=async()=>{const t=W();if(!t){i("You are not authenticated. Please log in."),console.log("No token found during save");return}if(!n.title||!n.code||!n.type||!n.discount){i("Please fill in all required fields (Title, Code, Type, Discount)");return}E(!0);try{const s=j?`${_}/coupons/${o._id||o.id}`:`${_}/coupons`,l=await fetch(s,{method:j?"PUT":"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({...n,code:n.code.toUpperCase().trim(),totalUses:n.totalUses?parseInt(n.totalUses):null,minPurchase:parseFloat(n.minPurchase)||0,discount:parseFloat(n.discount)||0,maxDiscount:n.maxDiscount?parseFloat(n.maxDiscount):null})}),d=await l.text();console.log(`${j?"Update":"Save"} coupon response status:`,l.status,"Response text:",d);let c;try{c=JSON.parse(d)}catch{throw console.error("Invalid JSON response:",d),new Error("Server returned invalid response format")}if(l.status===401){i("Session expired. Please log in again."),console.log("401 Unauthorized during save - but staying on page");return}if(c.success===!1)throw new Error(c.message||`Failed to ${j?"update":"create"} coupon`);if(!l.ok)throw new Error(c.message||`Server error: ${l.status}`);const a=c.data?.coupon||c.coupon||c;j?(w(h=>h.map(C=>(C._id||C.id)===(o._id||o.id)?{...C,...a}:C)),A("Coupon updated successfully!")):(a&&(a._id||a.id)&&w(h=>[a,...h]),A("Coupon created successfully!")),M(),setTimeout(()=>z(y,T),1e3)}catch(s){console.error("Save error:",s.message),i(s.message||`Failed to ${j?"update":"create"} coupon. Please try again.`)}finally{E(!1)}},je=t=>{S(t),$(!0)},fe=async()=>{const t=W();if(!t){i("You are not authenticated. Please log in.");return}if(o){Y(!0);try{const s=await fetch(`${_}/coupons/${o._id||o.id}`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`}}),x=await s.text();console.log("Delete coupon response status:",s.status,"Response text:",x);let l;try{l=x?JSON.parse(x):{}}catch{l={}}if(s.status===401){i("Session expired. Please log in again.");return}if(s.status===404){i("Coupon not found. It may have already been deleted."),w(d=>d.filter(c=>(c._id||c.id)!==(o._id||o.id))),$(!1),S(null);return}if(!s.ok)throw new Error(l.message||`Server error: ${s.status}`);w(d=>d.filter(c=>(c._id||c.id)!==(o._id||o.id))),A("Coupon deleted successfully!"),$(!1),S(null),setTimeout(()=>z(y,T),1e3)}catch(s){console.error("Delete error:",s.message),i(s.message||"Failed to delete coupon. Please try again.")}finally{Y(!1)}}},X=()=>{$(!1),S(null)},v=t=>{const{name:s,value:x}=t.target;N(l=>({...l,[s]:x}))},ye=t=>{de(t.target.value),H(1)},K=t=>{H(t)},V=()=>{z(y,T)},ve=()=>{Q("/login")},Ce=()=>{Q("/dashboard")},Z=t=>t?new Date(t)<new Date:!1,be=t=>t.isActive?Z(t.expireDate)?"warning":"success":"error",De=t=>t.isActive?Z(t.expireDate)?"Expired":"Active":"Inactive";return p&&I.length===0?e.jsx(F,{p:2,display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsxs(k,{alignItems:"center",spacing:2,children:[e.jsx(R,{}),e.jsx(g,{children:"Loading coupons..."})]})}):e.jsxs(F,{p:2,children:[e.jsx(g,{variant:"h4",gutterBottom:!0,children:"Coupons Management"}),e.jsx(ee,{open:!!f,autoHideDuration:null,onClose:()=>i(null),children:e.jsx(te,{severity:"error",onClose:()=>i(null),action:e.jsxs(k,{direction:"row",spacing:1,children:[f&&f.includes("not authenticated")&&e.jsx(m,{color:"inherit",size:"small",onClick:ve,children:"Go to Login"}),f&&f.includes("Access denied")&&e.jsx(m,{color:"inherit",size:"small",onClick:Ce,children:"Go to Dashboard"}),f&&!f.includes("not authenticated")&&!f.includes("Access denied")&&e.jsx(m,{color:"inherit",size:"small",onClick:V,children:"Retry"})]}),children:f})}),e.jsx(ee,{open:!!q,autoHideDuration:4e3,onClose:()=>A(null),children:e.jsx(te,{severity:"success",onClose:()=>A(null),children:q})}),e.jsxs(se,{open:le,onClose:M,maxWidth:"sm",fullWidth:!0,fullScreen:he,children:[e.jsx(ne,{children:j?`Edit Coupon: ${o?.code}`:"Add New Coupon"}),e.jsxs(re,{dividers:!0,children:[e.jsx(b,{fullWidth:!0,label:"Title *",name:"title",value:n.title,onChange:v,sx:{mb:2},required:!0,error:!n.title&&n.title!==""}),e.jsxs(B,{fullWidth:!0,name:"type",value:n.type,onChange:v,displayEmpty:!0,sx:{mb:2},required:!0,error:!n.type,children:[e.jsx(D,{value:"",children:"--Select coupon type *--"}),e.jsx(D,{value:"percentage",children:"Percentage"}),e.jsx(D,{value:"fixed_amount",children:"Fixed Amount"}),e.jsx(D,{value:"free_shipping",children:"Free Shipping"})]}),e.jsx(b,{fullWidth:!0,label:"Code *",name:"code",value:n.code,onChange:v,sx:{mb:2},required:!0,error:!n.code&&n.code!=="",helperText:"Coupon code will be automatically converted to uppercase",disabled:j}),e.jsx(b,{fullWidth:!0,label:"Total Uses",name:"totalUses",type:"number",value:n.totalUses,onChange:v,sx:{mb:2},inputProps:{min:1},helperText:"Leave empty for unlimited uses"}),e.jsx(b,{fullWidth:!0,type:"date",label:"Start Date",name:"startDate",value:n.startDate,onChange:v,InputLabelProps:{shrink:!0},sx:{mb:2}}),e.jsx(b,{fullWidth:!0,type:"date",label:"Expire Date",name:"expireDate",value:n.expireDate,onChange:v,InputLabelProps:{shrink:!0},sx:{mb:2}}),e.jsxs(B,{fullWidth:!0,name:"discountType",value:n.discountType,onChange:v,displayEmpty:!0,sx:{mb:2},children:[e.jsx(D,{value:"",children:"--Select discount type--"}),e.jsx(D,{value:"percentage",children:"Percentage (%)"}),e.jsx(D,{value:"amount",children:"Fixed Amount ($)"})]}),e.jsx(b,{fullWidth:!0,label:"Min Purchase Amount ($)",name:"minPurchase",type:"number",value:n.minPurchase,onChange:v,sx:{mb:2},inputProps:{min:0,step:.01}}),e.jsx(b,{fullWidth:!0,label:"Discount *",name:"discount",type:"number",value:n.discount,onChange:v,sx:{mb:2},required:!0,error:!n.discount&&n.discount!=="",inputProps:{min:0,step:.01}}),e.jsx(b,{fullWidth:!0,label:"Max Discount Amount ($)",name:"maxDiscount",type:"number",value:n.maxDiscount,onChange:v,sx:{mb:2},inputProps:{min:0,step:.01},helperText:"Only applicable for percentage discounts"}),j&&e.jsxs(B,{fullWidth:!0,name:"isActive",value:n.isActive,onChange:t=>N(s=>({...s,isActive:t.target.value})),sx:{mb:2},children:[e.jsx(D,{value:!0,children:"Active"}),e.jsx(D,{value:!1,children:"Inactive"})]})]}),e.jsxs(ae,{children:[e.jsx(m,{onClick:M,disabled:p,children:"Cancel"}),e.jsx(m,{variant:"contained",onClick:me,disabled:p,children:p?e.jsx(R,{size:20}):j?"Update Coupon":"Create Coupon"})]})]}),e.jsxs(se,{open:ce,onClose:X,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ne,{children:"Delete Coupon"}),e.jsxs(re,{children:[e.jsx(g,{variant:"body1",gutterBottom:!0,children:"Are you sure you want to delete this coupon?"}),o&&e.jsxs(F,{mt:2,p:2,bgcolor:"grey.100",borderRadius:1,children:[e.jsxs(g,{variant:"subtitle2",color:"primary",children:[e.jsx("strong",{children:"Code:"})," ",o.code]}),e.jsxs(g,{variant:"body2",children:[e.jsx("strong",{children:"Title:"})," ",o.title]}),e.jsxs(g,{variant:"body2",children:[e.jsx("strong",{children:"Type:"})," ",o.type]}),e.jsxs(g,{variant:"body2",children:[e.jsx("strong",{children:"Discount:"})," ",o.discountType==="percentage"?`${o.discount}%`:`$${o.discount}`]})]}),e.jsx(g,{variant:"body2",color:"error",mt:2,children:"This action cannot be undone."})]}),e.jsxs(ae,{children:[e.jsx(m,{onClick:X,disabled:U,children:"Cancel"}),e.jsx(m,{variant:"contained",color:"error",onClick:fe,disabled:U,children:U?e.jsx(R,{size:20}):"Delete"})]})]}),e.jsxs(Te,{sx:{mt:2,width:"100%"},children:[e.jsxs(k,{direction:{xs:"column",sm:"row"},spacing:2,justifyContent:"space-between",alignItems:{xs:"stretch",sm:"center"},p:2,children:[e.jsx(m,{variant:"contained",onClick:xe,disabled:p,children:"Add New Coupon"}),e.jsx(b,{label:"Search by title or code",variant:"outlined",size:"small",value:T,onChange:ye,sx:{maxWidth:{sm:300}},disabled:p})]}),p&&I.length>0&&e.jsx(F,{display:"flex",justifyContent:"center",p:2,children:e.jsx(R,{size:24})}),e.jsx(ke,{sx:{width:"100%",overflowX:"auto"},children:e.jsxs(Ae,{stickyHeader:!0,children:[e.jsx(Ie,{children:e.jsxs(J,{children:[e.jsx(r,{children:"S#"}),e.jsx(r,{children:"Title"}),e.jsx(r,{children:"Code"}),e.jsx(r,{children:"Type"}),e.jsx(r,{children:"Total Uses"}),e.jsx(r,{children:"Used"}),e.jsx(r,{children:"Min Purchase"}),e.jsx(r,{children:"Max Discount"}),e.jsx(r,{children:"Discount"}),e.jsx(r,{children:"Discount Type"}),e.jsx(r,{children:"Start Date"}),e.jsx(r,{children:"Expire Date"}),e.jsx(r,{children:"Status"}),e.jsx(r,{align:"center",children:"Actions"})]})}),e.jsx($e,{children:I.length===0&&!p?e.jsx(J,{children:e.jsx(r,{colSpan:14,align:"center",children:e.jsxs(k,{spacing:2,alignItems:"center",py:4,children:[e.jsx(g,{variant:"h6",color:"textSecondary",children:"No coupons found"}),f?e.jsx(m,{variant:"outlined",onClick:V,children:"Try Again"}):e.jsx(g,{variant:"body2",color:"textSecondary",children:'Create your first coupon using the "Add New Coupon" button'})]})})}):I.map((t,s)=>e.jsxs(J,{children:[e.jsx(r,{children:(y-1)*P.itemsPerPage+s+1}),e.jsx(r,{children:t.title||"-"}),e.jsx(r,{children:e.jsx(g,{variant:"body2",sx:{fontFamily:"monospace",fontWeight:"bold"},children:t.code||"-"})}),e.jsx(r,{children:t.type||"-"}),e.jsx(r,{children:t.totalUses||"Unlimited"}),e.jsx(r,{children:t.usedCount||0}),e.jsxs(r,{children:["$",t.minPurchase||0]}),e.jsx(r,{children:t.maxDiscount?`$${t.maxDiscount}`:"-"}),e.jsx(r,{children:t.discountType==="percentage"?`${t.discount}%`:`$${t.discount}`}),e.jsx(r,{children:t.discountType||"-"}),e.jsx(r,{children:t.startDate?new Date(t.startDate).toLocaleDateString():"-"}),e.jsx(r,{children:t.expireDate?new Date(t.expireDate).toLocaleDateString():"-"}),e.jsx(r,{children:e.jsx(Ee,{label:De(t),color:be(t),size:"small",variant:"outlined"})}),e.jsx(r,{align:"center",children:e.jsxs(k,{direction:"row",spacing:.5,justifyContent:"center",children:[e.jsx(oe,{title:"Edit Coupon",children:e.jsx(ie,{size:"small",color:"primary",onClick:()=>ge(t),disabled:p,children:e.jsx(Ue,{fontSize:"small"})})}),e.jsx(oe,{title:"Delete Coupon",children:e.jsx(ie,{size:"small",color:"error",onClick:()=>je(t),disabled:p||U,children:e.jsx(Ne,{fontSize:"small"})})})]})})]},t._id||t.id||s))})]})}),P.totalPages>1&&e.jsxs(k,{direction:"row",spacing:2,justifyContent:"center",alignItems:"center",p:2,children:[e.jsx(m,{variant:"outlined",disabled:y===1||p,onClick:()=>K(y-1),children:"Previous"}),e.jsxs(g,{variant:"body2",children:["Page ",P.currentPage," of ",P.totalPages,P.totalItems?` (${P.totalItems} total)`:""]}),e.jsx(m,{variant:"outlined",disabled:y===P.totalPages||p,onClick:()=>K(y+1),children:"Next"})]})]})]})};export{ze as default};
