import{r as p,u as ne,e as oe,a as re,j as e,B as U,S,C as E,T as y,Z as J,A as _,d as x,_ as ae,$ as ie,a0 as le,g as m,H as q,M as v,a1 as ce,K as de,J as ue,N as he,Q as pe,U as $,V as n,W as ge}from"./index-Bv9CUdV4.js";const H="https://api.bookmyevent.ae/api",me=()=>{const[D,I]=p.useState([]),[Y,W]=p.useState(!1),[c,w]=p.useState(!1),[d,i]=p.useState(null),[F,k]=p.useState(null),[C,G]=p.useState(""),[u,R]=p.useState(1),[f,M]=p.useState({currentPage:1,totalPages:1,totalItems:0,itemsPerPage:10}),[s,z]=p.useState({title:"",type:"",code:"",totalUses:"",startDate:"",expireDate:"",discountType:"",minPurchase:"",discount:"",maxDiscount:""}),Q=ne(),K=oe(Q.breakpoints.down("sm")),L=re(),N=()=>{const t=localStorage.getItem("token")||sessionStorage.getItem("token");return console.log("Retrieved token:",t?"Token exists":"No token found"),t},V=()=>{const t=localStorage.getItem("user")||sessionStorage.getItem("user");if(!t)return console.log("No user data found in storage"),null;try{const o=JSON.parse(t);return console.log("User role:",o.role),o.role}catch(o){return console.error("Error parsing user data:",o),null}},T=async(t=1,o="")=>{const j=N();if(!j){i("You are not authenticated. Please log in."),console.log("No token found");return}w(!0),i(null);try{const a=`${H}/auditorium-coupons?page=${t}&limit=10&search=${encodeURIComponent(o)}`;console.log("Fetching coupons from:",a);const l=await fetch(a,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${j}`}}),b=await l.text();console.log("API response status:",l.status,"Response text:",b);let r;try{r=JSON.parse(b)}catch{throw console.error("Invalid JSON response:",b),new Error("Server returned invalid response format. Please check server logs.")}if(l.status===401){i("Session expired. Please log in again."),console.log("401 Unauthorized - but staying on page");return}if(l.status===403){i("Access denied. You don't have permission to view coupons."),console.log("403 Forbidden - but staying on page");return}if(r.success===!1)throw console.error("API returned error:",r),new Error(r.message||"Failed to fetch coupons from server");if(!l.ok){console.error("Server error response:",r);const g=r.message||`Server error: ${l.status}`;throw new Error(g)}if(r.success!==!1){let g=[],P={currentPage:t,totalPages:1,totalItems:0,itemsPerPage:10};r.data&&r.data.coupons?(g=r.data.coupons,P=r.pagination||P):r.coupons?(g=r.coupons,P=r.pagination||P):Array.isArray(r)?g=r:r.data&&Array.isArray(r.data)&&(g=r.data),I(g),M(P),g.length===0&&i("No coupons found. You can create a new coupon using the 'Add New Coupon' button.")}else throw new Error(r.message||"Unknown error occurred while fetching coupons")}catch(a){console.error("Fetch error:",a);const l=a.message||"Network error occurred. Please check your connection and try again.";i(l),I([]),M({currentPage:1,totalPages:1,totalItems:0,itemsPerPage:10})}finally{w(!1)}};p.useEffect(()=>{const t=V(),o=N();if(console.log("Initial check - Token:",o?"Exists":"Missing","Role:",t),!o){console.log("No token found - showing error but staying on page"),i("You are not authenticated. Please log in.");return}if(t!=="superadmin"&&t!=="admin"){console.log("Not admin or superadmin - showing error but staying on page"),i("Access denied. Admin or Superadmin role required.");return}console.log("Proceeding to fetch coupons - role check passed"),T(u,C)},[u,C]);const X=()=>W(!0),A=()=>{W(!1),z({title:"",type:"",code:"",totalUses:"",startDate:"",expireDate:"",discountType:"",minPurchase:"",discount:"",maxDiscount:""})},Z=async()=>{const t=N();if(!t){i("You are not authenticated. Please log in."),console.log("No token found during save");return}if(!s.title||!s.code||!s.type||!s.discount){i("Please fill in all required fields (Title, Code, Type, Discount)");return}w(!0);try{const o=await fetch(`${H}/auditorium-coupons`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({...s,code:s.code.toUpperCase().trim(),totalUses:parseInt(s.totalUses)||1,minPurchase:parseFloat(s.minPurchase)||0,discount:parseFloat(s.discount)||0,maxDiscount:s.maxDiscount?parseFloat(s.maxDiscount):void 0,isActive:!0})}),j=await o.text();console.log("Save coupon response status:",o.status,"Response text:",j);let a;try{a=JSON.parse(j)}catch{throw console.error("Invalid JSON response:",j),new Error("Server returned invalid response format")}if(o.status===401){i("Session expired. Please log in again."),console.log("401 Unauthorized during save - but staying on page");return}if(a.success===!1)throw new Error(a.message||"Failed to create coupon");if(!o.ok)throw new Error(a.message||`Server error: ${o.status}`);const l=a.data?.coupon||a.coupon||a;l&&l._id?(I(b=>[l,...b]),k("Coupon created successfully!"),A(),setTimeout(()=>T(u,C),1e3)):(k("Coupon created successfully!"),A(),T(u,C))}catch(o){console.error("Save error:",o.message),i(o.message||"Failed to create coupon. Please try again.")}finally{w(!1)}},h=t=>{const{name:o,value:j}=t.target;z(a=>({...a,[o]:j}))},ee=t=>{G(t.target.value),R(1)},O=t=>{R(t)},B=()=>{T(u,C)},te=()=>{L("/login")},se=()=>{L("/dashboard")};return c&&D.length===0?e.jsx(U,{p:2,display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsxs(S,{alignItems:"center",spacing:2,children:[e.jsx(E,{}),e.jsx(y,{children:"Loading coupons..."})]})}):e.jsxs(U,{p:2,children:[e.jsx(y,{variant:"h4",gutterBottom:!0,children:"Coupons Management"}),e.jsx(J,{open:!!d,autoHideDuration:null,onClose:()=>i(null),children:e.jsx(_,{severity:"error",onClose:()=>i(null),action:e.jsxs(S,{direction:"row",spacing:1,children:[d&&d.includes("not authenticated")&&e.jsx(x,{color:"inherit",size:"small",onClick:te,children:"Go to Login"}),d&&d.includes("Access denied")&&e.jsx(x,{color:"inherit",size:"small",onClick:se,children:"Go to Dashboard"}),d&&!d.includes("not authenticated")&&!d.includes("Access denied")&&e.jsx(x,{color:"inherit",size:"small",onClick:B,children:"Retry"})]}),children:d})}),e.jsx(J,{open:!!F,autoHideDuration:4e3,onClose:()=>k(null),children:e.jsx(_,{severity:"success",onClose:()=>k(null),children:F})}),e.jsxs(ae,{open:Y,onClose:A,maxWidth:"sm",fullWidth:!0,fullScreen:K,children:[e.jsx(ie,{children:"Add New Coupon"}),e.jsxs(le,{dividers:!0,children:[e.jsx(m,{fullWidth:!0,label:"Title *",name:"title",value:s.title,onChange:h,sx:{mb:2},required:!0,error:!s.title&&s.title!==""}),e.jsxs(q,{fullWidth:!0,name:"type",value:s.type,onChange:h,displayEmpty:!0,sx:{mb:2},required:!0,error:!s.type,children:[e.jsx(v,{value:"",children:"--Select coupon type *--"}),e.jsx(v,{value:"percentage",children:"Percentage"}),e.jsx(v,{value:"fixed_amount",children:"Fixed Amount"}),e.jsx(v,{value:"free_shipping",children:"Free Shipping"})]}),e.jsx(m,{fullWidth:!0,label:"Code *",name:"code",value:s.code,onChange:h,sx:{mb:2},required:!0,error:!s.code&&s.code!=="",helperText:"Coupon code will be automatically converted to uppercase"}),e.jsx(m,{fullWidth:!0,label:"Total Uses",name:"totalUses",type:"number",value:s.totalUses,onChange:h,sx:{mb:2},inputProps:{min:1},helperText:"Leave empty for unlimited uses"}),e.jsx(m,{fullWidth:!0,type:"date",label:"Start Date",name:"startDate",value:s.startDate,onChange:h,InputLabelProps:{shrink:!0},sx:{mb:2}}),e.jsx(m,{fullWidth:!0,type:"date",label:"Expire Date",name:"expireDate",value:s.expireDate,onChange:h,InputLabelProps:{shrink:!0},sx:{mb:2}}),e.jsxs(q,{fullWidth:!0,name:"discountType",value:s.discountType,onChange:h,displayEmpty:!0,sx:{mb:2},children:[e.jsx(v,{value:"",children:"--Select discount type--"}),e.jsx(v,{value:"percentage",children:"Percentage (%)"}),e.jsx(v,{value:"amount",children:"Fixed Amount ($)"})]}),e.jsx(m,{fullWidth:!0,label:"Min Purchase Amount ($)",name:"minPurchase",type:"number",value:s.minPurchase,onChange:h,sx:{mb:2},inputProps:{min:0,step:.01}}),e.jsx(m,{fullWidth:!0,label:"Discount *",name:"discount",type:"number",value:s.discount,onChange:h,sx:{mb:2},required:!0,error:!s.discount&&s.discount!=="",inputProps:{min:0,step:.01}}),e.jsx(m,{fullWidth:!0,label:"Max Discount Amount ($)",name:"maxDiscount",type:"number",value:s.maxDiscount,onChange:h,sx:{mb:2},inputProps:{min:0,step:.01},helperText:"Only applicable for percentage discounts"})]}),e.jsxs(ce,{children:[e.jsx(x,{onClick:A,disabled:c,children:"Cancel"}),e.jsx(x,{variant:"contained",onClick:Z,disabled:c,children:c?e.jsx(E,{size:20}):"Create Coupon"})]})]}),e.jsxs(de,{sx:{mt:2,width:"100%"},children:[e.jsxs(S,{direction:{xs:"column",sm:"row"},spacing:2,justifyContent:"space-between",alignItems:{xs:"stretch",sm:"center"},p:2,children:[e.jsx(x,{variant:"contained",onClick:X,disabled:c,children:"Add New Coupon"}),e.jsx(m,{label:"Search by title or code",variant:"outlined",size:"small",value:C,onChange:ee,sx:{maxWidth:{sm:300}},disabled:c})]}),c&&D.length>0&&e.jsx(U,{display:"flex",justifyContent:"center",p:2,children:e.jsx(E,{size:24})}),e.jsx(ue,{sx:{width:"100%",overflowX:"auto"},children:e.jsxs(he,{stickyHeader:!0,children:[e.jsx(pe,{children:e.jsxs($,{children:[e.jsx(n,{children:"S#"}),e.jsx(n,{children:"Title"}),e.jsx(n,{children:"Code"}),e.jsx(n,{children:"Type"}),e.jsx(n,{children:"Total Uses"}),e.jsx(n,{children:"Used"}),e.jsx(n,{children:"Min Purchase"}),e.jsx(n,{children:"Max Discount"}),e.jsx(n,{children:"Discount"}),e.jsx(n,{children:"Discount Type"}),e.jsx(n,{children:"Start Date"}),e.jsx(n,{children:"Expire Date"}),e.jsx(n,{children:"Status"})]})}),e.jsx(ge,{children:D.length===0&&!c?e.jsx($,{children:e.jsx(n,{colSpan:13,align:"center",children:e.jsxs(S,{spacing:2,alignItems:"center",py:4,children:[e.jsx(y,{variant:"h6",color:"textSecondary",children:"No coupons found"}),d?e.jsx(x,{variant:"outlined",onClick:B,children:"Try Again"}):e.jsx(y,{variant:"body2",color:"textSecondary",children:'Create your first coupon using the "Add New Coupon" button'})]})})}):D.map((t,o)=>e.jsxs($,{children:[e.jsx(n,{children:(u-1)*f.itemsPerPage+o+1}),e.jsx(n,{children:t.title||"-"}),e.jsx(n,{children:e.jsx(y,{variant:"body2",sx:{fontFamily:"monospace",fontWeight:"bold"},children:t.code||"-"})}),e.jsx(n,{children:t.type||"-"}),e.jsx(n,{children:t.totalUses||"Unlimited"}),e.jsx(n,{children:t.usedCount||0}),e.jsxs(n,{children:["$",t.minPurchase||0]}),e.jsx(n,{children:t.maxDiscount?`$${t.maxDiscount}`:"-"}),e.jsx(n,{children:t.discountType==="percentage"?`${t.discount}%`:`$${t.discount}`}),e.jsx(n,{children:t.discountType||"-"}),e.jsx(n,{children:t.startDate?new Date(t.startDate).toLocaleDateString():"-"}),e.jsx(n,{children:t.expireDate?new Date(t.expireDate).toLocaleDateString():"-"}),e.jsx(n,{children:e.jsx(y,{variant:"body2",color:t.isActive?"success.main":"error.main",sx:{fontWeight:"medium"},children:t.isActive?"Active":"Inactive"})})]},t._id||t.id||o))})]})}),f.totalPages>1&&e.jsxs(S,{direction:"row",spacing:2,justifyContent:"center",alignItems:"center",p:2,children:[e.jsx(x,{variant:"outlined",disabled:u===1||c,onClick:()=>O(u-1),children:"Previous"}),e.jsxs(y,{variant:"body2",children:["Page ",f.currentPage," of ",f.totalPages,f.totalItems?` (${f.totalItems} total)`:""]}),e.jsx(x,{variant:"outlined",disabled:u===f.totalPages||c,onClick:()=>O(u+1),children:"Next"})]})]})]})};export{me as default};
